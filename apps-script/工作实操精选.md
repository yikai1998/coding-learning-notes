### get last row number from a range  
```gs
function getLastRow(sheet,rangeString){
  var rng = sheet.getRange(rangeString).getValues();
  var lrindex;
  for(var i = rng.length-1;i>=0;i--){
    lrindex = i
    if(!rng[i].every(function(c){ return c == ""; })){
      break;
    }
  }
  return lrindex +1;
}
```


### how to paste big size data
```gsf
/*
如果是跨表格，而且存在实时关联的公式，最好paste to一个disconnected的中间tab，然后再自动paste arrayformula连过去，避免gsheet延迟响应
*/
function copypaste_v2(sourcelink, sourcesheet, sourcerange, destilink, destisheet, destistartcell, if_cn) {
  var ssRaw = SpreadsheetApp.openByUrl(sourcelink);
  var sheetRaw = ssRaw.getSheetByName(sourcesheet);
  var rangeRaw = sheetRaw.getRange(sourcerange);
  var ssTo = SpreadsheetApp.openByUrl(destilink);
  var sheetTo = ssTo.getSheetByName(destisheet);
  var dataRaw = rangeRaw.getDisplayValues();
  var destRange = sheetTo.getRange(destistartcell);
  var destRow = destRange.getRow();
  var destColumn = destRange.getColumn();
  var batch_size = 500;
  
  // 分为 CN开头 和 非CN开头 两组
  var data_CN = [];
  var data_NonCN = [];
  if (if_cn) {
    for (var i = 0; i < dataRaw.length; i++) {
      var colVal = (dataRaw[i][3] || ''); // 第4列，索引3
      if (!colVal || ['CN', 'SG', 'MY', 'HK'].includes(colVal.substring(0, 2))) {
        data_CN.push(dataRaw[i]);
      }
    }
    for (var i = 0; i < data_CN.length; i += batch_size) {
      var current_batch = data_CN.slice(i, i + batch_size);
      sheetTo.getRange(destRow + i, destColumn, current_batch.length, current_batch[0].length).setValues(current_batch);
      Logger.log('>> batch_CN: %s', i);
      SpreadsheetApp.flush();
      // Utilities.sleep(1000);
    }
  } else {
    for (var i = 0; i < dataRaw.length; i++) {
      var colVal = (dataRaw[i][3] || ''); // 第4列，索引3
      if (!['CN', 'SG', 'MY', 'HK'].includes(colVal.substring(0, 2))) {
        data_NonCN.push(dataRaw[i]);
      }
    }
    for (var i = 0; i < data_NonCN.length; i += batch_size) {
      var current_batch = data_NonCN.slice(i, i + batch_size);
      sheetTo.getRange(destRow + i, destColumn, current_batch.length, current_batch[0].length).setValues(current_batch);
      Logger.log('>> batch_NonCN: %s', i);
      SpreadsheetApp.flush();
      // Utilities.sleep(1000);
    }
  }
  
}
```


### how to set the menu in top bar  
```gs
function onOpen() {
  var subMenu1 = SpreadsheetApp.getUi().createMenu('Notification')
              .addItem('T60/30_Report', 'send_3060')
  var subMenu2 = SpreadsheetApp.getUi().createMenu('Reminder List')
              .addItem('T60 Block List Update', 'transferPR_T60')
              .addItem('T30 Alert List Replace', 'transferPR_T30')
  var subMenu_pr = SpreadsheetApp.getUi().createMenu('Periodic Review')
              .addSubMenu(
                SpreadsheetApp.getUi().createMenu('Notification').addItem('T60/30_Report', 'send_3060')
              )
              .addSeparator()
              .addSubMenu(
                SpreadsheetApp.getUi().createMenu('Reminder List')
                .addItem('T60 Block List Update', 'transferPR_T60')
                .addItem('T30 Alert List Replace', 'transferPR_T30')
              )
  var subMenu_mt = SpreadsheetApp.getUi().createMenu('Material Trigger')
              .addSubMenu(
                SpreadsheetApp.getUi().createMenu('Notification').addItem('T30/20_Report', 'send_2030')
              )
              .addSeparator()
              .addSubMenu(
                SpreadsheetApp.getUi().createMenu('Reminder List')
                .addItem('T30 Block List Update', 'transferMT_T30')
              )
  SpreadsheetApp.getUi().createMenu('🐢 SmartFunctions')
      .addSubMenu(subMenu_pr)
      .addSeparator()
      .addSubMenu(subMenu_mt)
      .addSeparator()
      .addItem('How to use', 'instruction')
      .addToUi();
}
```


### interact with jira  
#### get tickets queue list, with fields required  
```gs
function fetchJiraData() {
    var jiraUrl = 'https://airwallex.atlassian.net/rest/api/3/search'
    var username = 'ben.chen@airwallex.com'
    var apiToken = 'xxx'
    
    var jqlQuery = 'project = OPS_KYC and issuetype IN ("Ongoing KYC Review Request", "Periodic Review") and (updated > "2024/10/15 08:00" or status NOT IN ("REVIEW COMPLETED - PASSED", "REVIEW COMPLETED - NO NEEDED", "CLOSED PER COMMERCIAL TEAM REQUEST", "REVIEW COMPLETED - KICKOFF OFFBOARDING")) ORDER BY created ASC'
    var maxResults = 100 // Max results per request
    var startAt = 0      // Pagination start index
    var issues = []
    var total = Infinity
    var batch = 1
    
    var options = {
        'method': 'get',
        'headers': {
            'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + apiToken)
        }
    }

    while (startAt < total) {
        var response = UrlFetchApp.fetch(jiraUrl + '?jql=' + encodeURIComponent(jqlQuery) + '&maxResults=' + maxResults + '&startAt=' + startAt, options)
        var data = JSON.parse(response.getContentText())

        issues = issues.concat(data.issues)
        total = data.total // Total number of issues to fetch
        startAt += maxResults // Move to the next batch
        Logger.log('>> Batch %s', batch)
        batch += 1
    }

    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('After20241015')
    var result = [['Client Legal Entity ID',	'Issue Type',	'Key',	'Summary',	'Assignee',	'Reporter',	'Status',	'KYC Maker',	'KYC Checker',	'Account Activity Report Owner',	'Compliance Owner',	'TM Owner',	'Account ID',	'Trigger Reason',	'Trigger Type',	'Single Pass',	'Complex Case',	'KYC Case Tag',	'Trigger Set Off Time',	'Created',	'Updated',	'Priority',	'Be raised from which team']]
    
    issues.forEach(issue => {
        var row = [
            issue.fields.customfield_12706, //legal entity id
            issue.fields.issuetype.name, //issue type
            issue.key, //key
            issue.fields.summary, //summary
            issue.fields.assignee ? issue.fields.assignee.displayName : 'NaN', //assignee
            issue.fields.reporter.displayName, //reporter
            issue.fields.status.name, //status
            issue.fields.customfield_12714 ? issue.fields.customfield_12714[0].displayName : 'NaN', //maker
            issue.fields.customfield_12715 ? issue.fields.customfield_12715[0].displayName : 'NaN', //checker
            issue.fields.customfield_12723 ? issue.fields.customfield_12723[0].displayName : 'NaN', //aar owner
            issue.fields.customfield_12716 ? issue.fields.customfield_12716[0].displayName : 'NaN', //compliance
            issue.fields.customfield_12717 ? issue.fields.customfield_12717[0].displayName : 'NaN', //tm
            issue.fields.customfield_12707, //account id
            issue.fields.customfield_12720 ? (issue.fields.customfield_12720.child?issue.fields.customfield_12720.value+' - '+issue.fields.customfield_12720.child.value:issue.fields.customfield_12720.value+' - NaN') : 'NaN - NaN', //trigger reason
            issue.fields.customfield_12711 ? issue.fields.customfield_12711.value : (issue.fields.issuetype.name=='Periodic Review'?'Periodic Review':'NaN'), //trigger type
            issue.fields.customfield_12709 ? issue.fields.customfield_12709.value : 'NaN', //single pass or not
            issue.fields.customfield_12718 ? issue.fields.customfield_12718.value : 'NaN', // complex case or not
            issue.fields.customfield_12712 ? issue.fields.customfield_12712.value : 'NaN',// team tag gc/intl
            issue.fields.customfield_12704, // set off time
            issue.fields.created, //created
            issue.fields.updated, //updated
            issue.fields.priority.name, //priority
            issue.fields.customfield_12710 ? issue.fields.customfield_12710.value : 'NaN', //raised by which team
        ]
        result.push(row)
    })
    sheet.getRange(1, 1, result.length, result[0].length).setValues(result)
}
```

#### get tickets transition records  
```gs
// tickets that were last updated within 90 days
function jql_search() {
  var jiraUrl = 'https://airwallex.atlassian.net/rest/api/3/search'
  var username = 'ben.chen@airwallex.com'
  var apiToken = 'xxxx'
  
  var jqlQuery = "PROJECT IN (CEOPS) AND issuetype in ('CN Inbound File Upload','Multiple GA') AND updated >= -90d ORDER BY created ASC"
  var maxResults = 100 // Max results per request
  var startAt = 0      // Pagination start index
  var results = []
  var tickets = []
  var total = Infinity
  var options = {
    'method': 'get',
    'headers': {
        'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + apiToken)
    }
  }
  while (startAt < total) {
    var response = UrlFetchApp.fetch(jiraUrl + '?jql=' + encodeURIComponent(jqlQuery) + '&maxResults=' + maxResults + '&startAt=' + startAt, options)
    var data = JSON.parse(response.getContentText())

    results = results.concat(data.issues)
    total = data.total // Total number of issues to fetch
    startAt += maxResults // Move to the next batch
  }
  results.forEach(
    r => {
      tickets.push([r.key, r.fields.issuetype.name])
    }
  )

  return tickets
}

// status transition logs for single ticket
function transition_records(key=['CEOPS-24671', 'CN Inbound File Upload']) {
  var jiraUrl = 'https://airwallex.atlassian.net/rest/api/3/issue/'+key[0]+'?expand=changelog'
  var username = 'ben.chen@airwallex.com'
  var apiToken = 'xxx'
  var options = {
      'method': 'get',
      'headers': {
          'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + apiToken)
      }
  }
  var response = UrlFetchApp.fetch(jiraUrl, options)
  var now = new Date()
  var data = JSON.parse(response.getContentText());
  var results = []

  // Ensure the changelog and histories exist
  if (data.changelog && data.changelog.histories) {
    var records = data.changelog.histories;

    records.forEach(record => {
      // Iterate over the items in each history record
      if (Array.isArray(record.items)) {
        record.items.forEach(item => {
          var created = new Date(record.created)
          if (item.field == 'status' && record.author.emailAddress && ['KYC Maker in review', 'WAITING FOR APPROVAL - KYC'].includes(item.fromString) && Math.ceil((now-created) / (1000 * 60 * 60 * 24)) <= 90) {
            var row = [
              key[0],
              key[1],
              Utilities.formatDate(created, Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss'),
              record.author.emailAddress,
              item.fromString,
              item.toString
            ]
            results.push(row)
          }
        });
      }
    });
  } else {
    Logger.log('No changelog or history data available.');
  }

  return results
}

// status transition logs for thoese tickets which were last updated within 90 days
function mainRun() {
  var key_list = jql_search()
  var df = [['Key No.', 'Issue Type', 'Operate Time', 'Operator Mail', 'Status From', 'Status To']]
  var sh_log = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Review Logs [rolling 90d]')
  key_list.forEach(
    key => {
      Logger.log(key)
      var logs = transition_records(key=key)
      Logger.log(logs)
      df = df.concat(logs)
    }
  )
  sh_log.clear()
  sh_log.getRange(1, 1, df.length, df[0].length).setValues(df)
}
```


### how to write instroduction wallpaper in menu selection  
#### html  
```html
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <p><b>Part A: Periodic Review</b></p>
  </head>
  <body>
    <p>Tabs of [`Refresh of Old Jira` | `Refresh of New Jira` | `Workpaper-A`] are all generated from <a href = 'https://colab.research.google.com/drive/19JINNHOVQ3OlamlUdEWTEu88BDdAPaOH#scrollTo=1K0WT7bSQbSJ'>Python Tool</a> firstly, you can follow the handbook in Tool to know how to read them.</p>
    <p>Tab of [`Helper Tab`] is used for reference when running tool, it includes head mapping logic and block list from <a href = 'https://docs.google.com/spreadsheets/d/1aAlmuZneIJmcfQMxgkKxNOwWj0uLWSudT3jjFbJzOZs/edit?gid=0#gid=0'>LongPending Gsheet</a></p>
    <p>Tab of [`Workpaper-B`] is used for managing mail settings, like subjects, to_list, cc_list;
      <br>>> mail subject is totally auto generated by mail tool itself;
      <br>>> columns E, F, G, H are all mail addresses, F is auto list of all account owners, the others are all free-edit lists;
      <br>>> before sending mail, remember to update the column A and B here, by copying lists from right side;
      <br>>> you must at least input 1 to_mail and 1 cc_mail here, or it would raise bug error while running;
    </p>
    <p>Click the 'T60/30_Report' in SmartFunctions to send the mail
      <br>>> it is sugguested that the first mail can be sent to your own private inbox, to check the output;
      <br>>> if the amount of cc and to receivers is more than 100, script would go wrong, and a letter would be generated in kyc ops inbox to notify you about this;
    </p>
    <p>Click the 'T60 Block List Update' in SmartFunctions to add the T60 clients in the backend of <a href = 'https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0'>block list</a></p>
    <p>Click the 'T30 Alert List Replace' in SmartFunctions to fully replace the T30 clients on <a href = 'https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0'>pending list</a></p>
  </body> 
  <div style="height: 50px;"></div>
  <head>
    <base target="_top">
    <p><b>Part B: Material Trigger</b></p>
  </head>
  <body>
    <p>Old Jira would not be involved here, because the client there have all been added into watchlist and not need for refreshing any more.</p>
    <p>Tabs of [`Refresh of New Jira` | `Workpaper-A`] are both generated from <a href = 'https://colab.research.google.com/drive/19rR3ddHGBXi3nOGFvlT9mgbLqjWFYz3z#scrollTo=Jswe4RQl7McH'>Python Tool</a> firstly, you can follow the handbook in Tool to know how to read them.</p>
    <p>Tab of [`Helper Tab`] is used for reference when running tool, it includes head mapping logic and watchlist list from <a href = 'https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=877572013#gid=877572013'>LongPending Gsheet</a></p>
    <p>Tab of [`Workpaper-B`] is used for managing mail settings, like to_list, cc_list;
      <br>>> mail subject is totally auto generated by mail tool itself;
      <br>>> columns E, F, G, H are all mail addresses, F is auto list of all account owners, the others are all free-edit lists;
      <br>>> before sending mail, remember to update the column A and B here, by copying lists from right side;
      <br>>> you must at least input 1 to_mail and 1 cc_mail here, or it would raise bug error while running;
    </p>
    <p>Click the 'T30/20_Report' in SmartFunctions to send the mail
      <br>>> it is sugguested that the first mail can be sent to your own private inbox, to check the output;
      <br>>> if the amount of cc and to receivers is more than 100, script would go wrong, and a letter would be generated in kyc ops inbox to notify you about this;
    </p>
    <p>Click the 'T30 Block List Update' in SmartFunctions to add the T30 clients in the backend of <a href = 'https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0'>block list</a></p>
  </body>
</html>
```

#### call html  
```gs
function instruction() {
  var htmlOutput = HtmlService.createHtmlOutputFromFile('how_to_use.html')
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'How to use this Gsheet to send weekly report')
}
```


### how to send a mail, using the template written by html
#### html
```html
<!DOCTYPE html>
<html>
  <head>
    <style>
        .spaced {
            margin-bottom: 60px; /* Adjust as needed for spacing */
        }
    </style>
  </head>
  <body>
    <p>Hi Commercial Team</p>
    <p>Kindly find the weekly tracking report of the KYC periodical review (PR) long-pending client list as below, and the REQUIRED ACTION is also highlighted for your attention and follow-up.</p>
    <p><b>Here is the full list for your reference: </b><a href = 'https://lookerstudio.google.com/u/0/reporting/f41789bb-a2af-4897-aa15-7982d33437e5/page/i376D'>KYC Periodical Review (PR) & Material Trigger (MT) Long Pending Client List</a></p>

    <!-- Part of T60 clients -->
    <p class='spaced'></p>
    <p style='color:red;'><b>Part 1: Below newly identified client's KYC PR is overdue more than 60 days without a response, all future transactions from the client will be blocked until PR is completed.</b></p>
    <? if (t60_len == 0) { ?> 
      <p><b>No customer should be newly added into watchlist.</b></p>
    <? } else { ?>
      <p><b>REQUIRED ACTION: </b></p>
      <p><b>1) Please help to contact the respective client ASAP and complete the PR review, or</b></p>
      <p><b>2) Inform the KYC team to offboard the client if no future relationship is required</b></p>
      <table border='1' cellspacing='0'>
        <thead>
          <tr bgcolor='lightblue'>
          <? for (var i = 0; i < head_t60.length; i++) { ?>
              <th style='white-space:nowrap'><?= head_t60[i] ?></th>
          <? } ?>
          </tr>
        </thead>
        <tbody>
          <? for (var i = 0; i < data_t60.length; i++) { ?>
            <tr>
              <td><?= data_t60[i].summary ?></td>
              <td><?= data_t60[i].legalEntityId ?></td>
              <td><?= data_t60[i].customerSegment ?></td>
              <td><?= data_t60[i].accountOwner ?></td>
              <td><?= data_t60[i].head ?></td>
              <td><?= data_t60[i].lastRfiTime ?></td>
            </tr>
          <? } ?>
        </tbody>
      </table>
      <p>KYC will add into watchlist accordingly.</p>
      <p>Hi 
        <? for (var i = 0; i < cn_head_t60.length; i++) { ?>
          <a href = 'mailto: https://www.airwallex.com/'><?= cn_head_t60[i] ?></a>, 
        <? } ?>
        KYC will place the control on customers until the review is completed, and the KYC review RFI has been sent; Please help to inform the right teammate if the owner changes.
      </p>
      <p>Hi 
        <? for (var i = 0; i < intl_head_t60.length; i++) { ?>
          <a href = 'mailto: https://www.airwallex.com/'><?= intl_head_t60[i] ?></a>, 
        <? } ?>
        KYC will place the control on customers until the review is completed, you should have been cc-ed in these KYC review RFI emails, and if need further assistance please approach to <a href = 'mailto: joann.qiu@airwallex.com'>Joann Qiu</a>
      </p>
    <? } ?>

    <!-- Part of T30 clients -->
    <p class='spaced'></p>
    <p style='color:red;'><b>Part 2: Below client's KYC PR is overdue for more than 30 days without a response, if no response before the Due date (T+60), the client's future transactions will be blocked.</b></p>
    <? if (t30_len == 0) { ?> 
      <p><b>No customer in T+30.</b></p>
    <? } else { ?>
      <p><b>REQUIRED ACTION: </b></p>
      <p><b>1) Please help to contact the respective client ASAP and complete the PR review, or</b></p>
      <p><b>2) Inform the KYC team to offboard the client if no future relationship is required</b></p>
      <table border='1' cellspacing='0'>
        <thead>
          <tr bgcolor='lightblue'>
          <? for (var i = 0; i < head_t30.length; i++) { ?>
              <th style='white-space:nowrap'><?= head_t30[i] ?></th>
          <? } ?>
          </tr>
        </thead>
        <tbody>
          <? for (var i = 0; i < data_t30.length; i++) { ?>
            <tr>
              <td><?= data_t30[i].summary ?></td>
              <td><?= data_t30[i].legalEntityId ?></td>
              <td><?= data_t30[i].customerSegment ?></td>
              <td><?= data_t30[i].accountOwner ?></td>
              <td><?= data_t30[i].head ?></td>
              <td><?= data_t30[i].lastRfiTime ?></td>
              <td><?= data_t30[i].dueDate ?></td>
            </tr>
          <? } ?>
        </tbody>
      </table>
      <p>Hi 
        <? for (var i = 0; i < cn_head_t30.length; i++) { ?>
          <a href = 'mailto: https://www.airwallex.com/'><?= cn_head_t30[i] ?></a>, 
        <? } ?>
        KYC review RFI has been sent; Please help to inform the right teammate if the owner changes.
      </p>
      <p>Hi 
        <? for (var i = 0; i < intl_head_t30.length; i++) { ?>
          <a href = 'mailto: https://www.airwallex.com/'><?= intl_head_t30[i] ?></a>, 
        <? } ?>
        you should have been cc-ed in these KYC review RFI emails, and if need further assistance please approach to <a href = 'mailto: joann.qiu@airwallex.com'>Joann Qiu</a>
      </p>
    <? } ?>
    <p>Best regards,<br>KYC Operation Team</p>
  </body>
</html>
```

#### mail part
```gs
function dataGroupPR() {

  const work_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Workpaper-A')
  var pending_q60 = []
  var pending_q45 = []
  var pending_q30 = []
  const rawdata = work_sheet.getRange('A2:Q'+getLastRow(work_sheet,'A:A')).getDisplayValues()

  for (var i=0; i<rawdata.length; i++) {
    if (rawdata[i][9]==' [T+60]') {
      pending_q60.push({
        summary: rawdata[i][2],
        legalEntityId: rawdata[i][1],
        customerSegment: rawdata[i][11],
        orgL2: rawdata[i][12],
        accountOwner: rawdata[i][13],
        head: rawdata[i][16],
        lastRfiTime: rawdata[i][4].substring(0, 19)
      })
    }
    else if (rawdata[i][9]==' [T+30]' || rawdata[i][9]==' [T+45]') {
      pending_q30.push({
        summary: rawdata[i][2],
        legalEntityId: rawdata[i][1],
        customerSegment: rawdata[i][11],
        orgL2: rawdata[i][12],
        accountOwner: rawdata[i][13],
        head: rawdata[i][16],
        lastRfiTime: rawdata[i][4].substring(0, 19),
        dueDate: rawdata[i][7].substring(0, 10),
      })
    }

  }
  
  return [pending_q30, pending_q45, pending_q60]
}


function send_3060() {
  let datagroup = dataGroupPR()
  var htmlTemplate = HtmlService.createTemplateFromFile('mail_content_t3060.html')

  // part of T60
  var head_t60 = ['Client Name', 'Legal Entity Id', 'Customer Segment', 'Account Owner', 'Commercial Head', 'Last RFI Time']
  var data_t60 = datagroup[2]
  var cn_head_t60 = []
  var intl_head_t60 = []
  data_t60.forEach(
    r => {
      r.orgL2.substring(0, 2) == 'CN' ? cn_head_t60.push(r.head) : {}
      r.orgL2.substring(0, 2) != 'CN' ? intl_head_t60.push(r.head) : {}
    }
  )
  cn_head_t60 = [... new Set(cn_head_t60)]
  intl_head_t60 = [... new Set(intl_head_t60)]
  htmlTemplate.data_t60 = data_t60  // Pass the t60 data array to the template
  htmlTemplate.head_t60 = head_t60
  htmlTemplate.t60_len = data_t60.length
  htmlTemplate.cn_head_t60 = cn_head_t60
  htmlTemplate.intl_head_t60 = intl_head_t60
  // htmlTemplate.t60_len = 0

  // part of T30
  var head_t30 = ['Client Name', 'Legal Entity Id', 'Customer Segment', 'Account Owner', 'Commercial Head', 'Last RFI Time', 'Due Date']
  var data_t30 = datagroup[0]
  var cn_head_t30 = []
  var intl_head_t30 = []
  data_t30.forEach(
    r => {
      r.orgL2.substring(0, 2) == 'CN' ? cn_head_t30.push(r.head) : {}
      r.orgL2.substring(0, 2) != 'CN' ? intl_head_t30.push(r.head) : {}
    }
  )
  cn_head_t30 = [... new Set(cn_head_t30)]
  intl_head_t30 = [... new Set(intl_head_t30)]
  htmlTemplate.data_t30 = data_t30  // Pass the t60 data array to the template
  htmlTemplate.head_t30 = head_t30
  htmlTemplate.t30_len = data_t30.length
  htmlTemplate.cn_head_t30 = cn_head_t30
  htmlTemplate.intl_head_t30 = intl_head_t30

  // pass the processed html template into gmail app
  var htmlBody = htmlTemplate.evaluate().getContent()

  // get the title, to, cc
  let mailsetting = getMailSet()
  var mail_subject = 'Weekly Report - KYC Periodical Review (PR) Long Pending Client List' + mailsetting[0]
  var mail_to = mailsetting[1]
  var mail_cc = mailsetting[2]

  if (mail_to.length+mail_cc.length > 100) {
    GmailApp.sendEmail(
      'kyc.ops@airwallex.com',
      'Error Response - ' + mail_subject,
      '收件人超过上限；调整一下，先单独发给自己的邮箱，再手动复制黏贴群发。'
    )
  } else {
    GmailApp.sendEmail(
      mail_to.join(','),
      mail_subject,
      '',
      {htmlBody: htmlBody, cc: mail_cc.join(','), replyTo: 'joann.qiu@airwallex.com'}
      )
    Browser.msgBox('🍻Mail is delivered successfully!')
    }
}
```

---

### jump out dialog to input something, with the help of html
```html
<!DOCTYPE html>
<html>
  <body>
    <form id="inputForm" onsubmit="handleSubmit(); return false;">
      <label for="token">Airwallex Token:</label><br>
      <input type="text" id="token" name="token" style="width:95%;" required><br><br>
      <label for="accountid">Account ID:</label><br>
      <input type="text" id="accountid" name="accountid" style="width:95%;" required><br><br>
      <label for="clientname">Client Name:</label><br>
      <input type="text" id="clientname" name="clientname" style="width:95%;" required><br><br>
      <input type="submit" value="submit">
    </form>
    <script>
      function handleSubmit() {
        var token = document.getElementById('token').value.trim();
        var accountid = document.getElementById('accountid').value.trim();
        var clientname = document.getElementById('clientname').value.trim();
        if(token && accountid && clientname) {
          google.script.run
            .withSuccessHandler(function(){google.script.host.close();})
            .infoProcess(token, accountid, clientname);
        } else {
          alert('null error!');
        }
      }
    </script>
  </body>
</html>
```
```gs
function showDialog() {
  var html = HtmlService.createHtmlOutputFromFile('InfoCollection')
    .setWidth(350)
    .setHeight(240);
  DocumentApp.getUi().showModalDialog(html, 'Fill in the blanks');
}

// 处理表单内容
function infoProcess(token, accountid, clientname) {
  // 可保存到属性、全局变量等
  PropertiesService.getUserProperties().setProperty('API_TOKEN', token);
  PropertiesService.getUserProperties().setProperty('ACCOUNT_ID', accountid);
  PropertiesService.getUserProperties().setProperty('CLIENT_NAME', clientname);
  // 需要的话，此处还能做更多处理
  Logger.log('Token:' + token);
  Logger.log('AccountId:' + accountid);
  Logger.log('ClientName:' + clientname);
  // 完成克隆
  var newTitle = PropertiesService.getUserProperties().getProperty('CLIENT_NAME');
  newTitle = `QBC DD Questionnaire - ${newTitle}`;
  var file = DriveApp.getFileById(DocumentApp.getActiveDocument().getId());
  var copiedFile = file.makeCopy(newTitle);
  var copiedUrl = copiedFile.getUrl();
  PropertiesService.getUserProperties().setProperty('COPIED_URL', copiedUrl);
}

function getHeaders(datacenter) {
  return {
    'Content-Type': 'application/json',
    'authorization': PropertiesService.getUserProperties().getProperty('API_TOKEN') || '',
    'x-data-center': datacenter
  };
}
```


### jump out dialog to input something, without the help of html file
```gs
function showOpenDialog(url) {
  var html = HtmlService.createHtmlOutput(
    "<div>Copied and Updated. Click to open the new file.<br><br>" +
    "<button onclick='window.open(\"" + url + "\", \"_blank\");google.script.host.close()'>Open New File</button></div>"
  )
  .setWidth(300)
  .setHeight(100);
  DocumentApp.getUi().showModalDialog(html, "Open New File");
}

function copyCurrentDocWithCustomTitle() {
  
  // 收集克隆表的基本信息
  var ui = DocumentApp.getUi();
  var response = ui.prompt('You are going to clone a new Doc', 'Please input the client name:', ui.ButtonSet.OK_CANCEL);

  if (response.getSelectedButton() != ui.Button.OK) {
    ui.alert('User cancelled.');
    return 0;
  }

  var newTitle = response.getResponseText();
  if (!newTitle) {
    ui.alert('Error! Client name should not be null.');
    return 0;
  }

  // 完成克隆
  var newTitle = PropertiesService.getUserProperties().getProperty('CLIENT_NAME');
  newTitle = `QBC DD Questionnaire - ${newTitle}`;
  var file = DriveApp.getFileById(DocumentApp.getActiveDocument().getId());
  var copiedFile = file.makeCopy(newTitle);
  var copiedUrl = copiedFile.getUrl();

  // 克隆表展示
  showOpenDialog(url=copiedUrl);
}
```


### update the range content (replace and append)  
```gs
function transferPR_T30() {

  const work_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Workpaper-A')
  const to_sheet = SpreadsheetApp.openByUrl('https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0').getSheetByName('Periodical Review (PR)')
  const rawdata = work_sheet.getRange('A2:O'+getLastRow(work_sheet,'A:A')).getDisplayValues()
  let pending_queue = []

  for (var i=0; i<rawdata.length; i++) {
    if (rawdata[i][9]==' [T+30]' || rawdata[i][9]==' [T+45]') {
      pending_queue.push([
        rawdata[i][2], //summary
        rawdata[i][1], //legalEntityId
        'PR Reminder: over 30 days no RFI responce',
        rawdata[i][13], //accountOwner
        rawdata[i][11], //customerSegment
        rawdata[i][12], //org_L2
        'Added on ' + Utilities.formatDate(new Date(),"GMT+8","yyyy-MM-dd")
      ])
    }
  }

  var current_list = to_sheet.getRange('A2:G'+getLastRow(to_sheet,'B:B')).getDisplayValues()
  current_list = current_list.filter(r => r[2] != 'PR Reminder: over 30 days no RFI responce')
  current_list = current_list.concat(pending_queue)

  to_sheet.getRange('A2:H').clear()
  to_sheet.getRange(2, 1, current_list.length, current_list[0].length).setValues(current_list)

  Browser.msgBox('🍻Reminder list is updated successfully!')
}


function transferPR_T60() {

  const work_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Workpaper-A')
  const to_sheet = SpreadsheetApp.openByUrl('https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0').getSheetByName('Periodical Review (PR)')
  const rawdata = work_sheet.getRange('A2:O'+getLastRow(work_sheet,'A:A')).getDisplayValues()
  let pending_queue = []

  for (var i=0; i<rawdata.length; i++) {
    if (rawdata[i][9] == ' [T+60]') {
      pending_queue.push([
        rawdata[i][2], //summary
        rawdata[i][1], //legalEntityId
        'PR Block tanx: Over 60 days no RFI responce',
        rawdata[i][13], //accountOwner
        rawdata[i][11], //customerSegment
        rawdata[i][12], //org_L2
        'Added on ' + Utilities.formatDate(new Date(),"GMT+8","yyyy-MM-dd")
      ])
    }
  }

  to_sheet.getRange(getLastRow(to_sheet,'A:A')+1, 1, pending_queue.length, pending_queue[0].length).setValues(pending_queue)
  to_sheet.getRange(2, 1, to_sheet.getLastRow()-1, to_sheet.getLastColumn()).sort({column: 3, ascending: true})

  Browser.msgBox('🍻Block list is updated successfully!')
}
```


### interact with slack  
#### send msg to channel  
```gs
function slackapp_last_msg(month, ticket, amount, days, sla, comment, slackurl, gsheeturl) {
  
  var param = {

    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(
      {
				"type": "mrkdwn",
				"text": '📢📢 *Issuing Recon Breaks Overdue Reminder*' + '\n' + '\n'
              + '• *Month:* ' + month + '\n'
              + '• *Jira Ticket:* ' + '<https://airwallex.atlassian.net/browse/' + ticket + '|' + ticket + '>' + '\n'
              + '• *Pending Amount ($):* ' + amount + '\n'
              + '• *SLA Target:* ' + sla + '\n' 
              + '• *Pending Days:* ' + days + ' days' + '\n' 
              + '• *Comments from Issuing:* ' + comment + '\n' + '\n'
              // + '<@U01AS2QKZL2> ' + '<@U014TU31HH9>' + '\n' + '\n' // 只希望出现在最后一条msg通知里，其他的msg不要出现@person了
              + '<' + gsheeturl + ' | Link to the full list and details>' // 只希望出现在最后一条msg通知里，其他的msg不要出现link了
      }
    )
  }

  UrlFetchApp.fetch(slackurl, param)
  Logger.log(param)

}

function slackapp(month, ticket, amount, days, sla, comment, slackurl) {
  
  var param = {

    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(
      {
				"type": "mrkdwn",
				"text": '📢📢 *Issuing Recon Breaks Overdue Reminder*' + '\n' + '\n'
              + '• *Month:* ' + month + '\n'
              + '• *Jira Ticket:* ' + '<https://airwallex.atlassian.net/browse/' + ticket + '|' + ticket + '>' + '\n'
              + '• *Pending Amount ($):* ' + amount + '\n'
              + '• *SLA Target:* ' + sla + '\n' 
              + '• *Pending Days:* ' + days + ' days' + '\n' 
              + '• *Comments from Issuing:* ' + comment + '\n'
      }
    )
  }

  UrlFetchApp.fetch(slackurl, param)
  Logger.log(param)

}



function slackapp_Run() {

  const sheet_from = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Record')
  const content = sheet_from.getRange(2, 1, getLastRow(sheet_from, 'A:A')-1, 7).getDisplayValues()
  // const slackurl = 'https://hooks.slack.com/services/testxxx/B050KK3HSD6/bP2NuOnYSxKJXgwKFGixswpf' // Test Use Only
  const slackurl = 'https://hooks.slack.com/services/testxxx/B06U8N1BTMG/1DhZ8CeYKR4g6PfT2gqK92ZN' // linked with channel of # issuing-recon
  // const slackurl = 'https://hooks.slack.com/services/testxxx/B06U0PLLTDZ/LDO8PHJ9Dh0lwHiHBeLhSmFv' // linked with channel of # issuing-recon-breaks-alert-test
  const gsheeturl = 'https://docs.google.com/spreadsheets/d/1xOb36DN_uAyZ2ebKfxjcqAGKSCCtNxAyOjXw5yeNgzQ/edit#gid=312672034'
  const overdue_amt = sheet_from.getRange('F:F').getDisplayValues().flat().filter(x => x=='Overdue').length

  var i = 1

  content.forEach(

    r => {

      let month = r[0]
      let ticket = r[1]
      let amount = r[2]
      let days = r[3]
      let sla = r[4]
      let status = r[5]
      let comment = r[6]

      Logger.log(r)

      if (status == 'Overdue' && i == overdue_amt) {
        slackapp_last_msg(month, ticket, amount, days, sla, comment, slackurl, gsheeturl)
        
      }
      else if (status == 'Overdue' && i != overdue_amt) {
        slackapp(month, ticket, amount, days, sla, comment, slackurl)
        i += 1
      }
      else {
        Logger.log('%s %s %s %s %s %s', month, ticket, amount, days, sla, status, comment)
      } 

      Utilities.sleep(500) //freeze 0.5s

    }

  )

}
```

#### dynamically mention people  
```gs
// mock user mapping based on owning-entity and txn-type
var userMapping = {
  'AU': {
    'FEE': ["U059ZSBCAD9"],
    'ADJUSTMENT': ["U059ZSBCAD9", "UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["U059ZSBCAD9"],
    'CONVERSION': ["U059ZSBCAD9"],
    'CARD_TX': ["U059ZSBCAD9", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U059ZSBCAD9", "U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'PAYMENT': ["U059ZSBCAD9", "U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DC_DEBIT': ["U059ZSBCAD9", "UA437DMEK"],
    'DD_DEBIT': ["U059ZSBCAD9", "UA437DMEK"],
    'PURCHASE': ["U059ZSBCAD9", "U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  },
  'CN': {
    'FEE': ["UEHLJM5FF", "UA437DMEK"],
    'ADJUSTMENT': ["UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["UA437DMEK"],
    'CONVERSION': ["UEHLJM5FF", "UA437DMEK"],
    'CARD_TX': ["UEHLJM5FF", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'PAYMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DC_DEBIT': ["UEHLJM5FF", "UA437DMEK"],
    'DD_DEBIT': ["UEHLJM5FF", "UA437DMEK"],
    'PURCHASE': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  },
  ...,
  'Others': {
    'FEE': ["UC01YJ823"],
    'ADJUSTMENT': ["UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["UC01YJ823"],
    'CONVERSION': ["UC01YJ823", "UA437DMEK"],
    'CARD_TX': ["UC01YJ823", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'PAYMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DC_DEBIT': ["UC01YJ823", "UA437DMEK"],
    'DD_DEBIT': ["UC01YJ823", "UA437DMEK"],
    'PURCHASE': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  }
};

function slackapp_template_10k(account_id, legal_entity_id, client_name, owning_entity, org_l2, account_owner, last_nb_date, net_account_balance_usd, txn_mapping_id, nb_txn_type, nb_txn_sub_typ, nb_txn_domain, nb_txn_reason, url) {
  var country_code = String(org_l2).substring(0, 2)
  var knownRegions = ['AU', 'CN', 'HK', 'SG', 'UK', 'US']
  var region = knownRegions.includes(country_code) ? country_code : 'Others'
  // defaults to xxx if no mapping is found
  var userIds = ["UC01YJ823", "UR0STDE9F"]
  // fetch user ids
  if (userMapping[region] && userMapping[region][nb_txn_type]) {
    userIds = userMapping[region][nb_txn_type];
  }
  // construct dynamic user mention elements, with delimiters
  var userMentionElements = [];
  userIds.forEach((userId, index) => {
    userMentionElements.push({
      "type": "user",
      "user_id": userId
    });
    // add a space after every user mention, except the last one
    if (index < userIds.length - 1) {
      userMentionElements.push({
        "type": "text",
        "text": " "
      });
    }
  });
  // block kit
  var param = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({
      'text': 'This is the fallback text for clients that do not support blocks',
      'blocks': [
			  ...
              {
                "type": "link",
                "url": "https://lookerstudio.google.com/u/0/reporting/d323ec88-3699-4e1e-a01c-c4cac622c0c2/page/cZMdE",
                "text": "Go to dashboard"
              },
              {
                "type": "text",
                "text": "\n\nHi "
              },
              ...userMentionElements,  // spread the user mentions into the elements array
              {
                "type": "text",
                "text": ", the Net Account Balance of this client has fallen below $-10K, please take the necessary follow-up actions. "
              },
              ...
            ]
				  }
        ]
        }
      ]
    })
  }

  UrlFetchApp.fetch(url, param)
  Utilities.sleep(1000)
}
```

#### dynamically any part - similar above
```gs
  var rfiListElements = [];
  if (s4[region]) {
  s4[region].forEach(r => {
      rfiListElements.push(
        {"type": "text", "text": r[1], "style": {"code": true}},
        {"type": "text", "text": " received "},
        {"type": "text", "text": r[3], "style": {"code": true}},
        {"type": "text", "text": " time(s) of RFI \n"}
      )
    });
  }
```

#### bullet list and make the blank spaces dynamic structured
```gs
...
  var element_list = []
  for (i in content) {
    element_list.push(
      `{
        "type": "rich_text_section",
        "elements": [
          {
            "type": "text",
            "text": "${content[i][16]} hrs",
            "style": {
              "code": true
            }
          },
          {
            "type": "text",
            "text": "${' '.repeat(Math.max(...[8 - `${content[i][16]}`.toString().length, 2]))}"        
          },
          {
            "type": "text",
            "text": " CLE Id: ${content[i][1]} "
          }
        ]
      }`
    )
  }
...
    {
      "type": "rich_text_list",
      "style": "bullet",
      "indent": 0,
      "border": 0,
      "elements": convertStringToJsonArray(element_list)
    },
...
```

#### remove the part of block after the block has already been created
```gs
    let arr = block.blocks[0].elements;
    var property_name = `${region}_DAILY_QUOTA`;
    if (PropertiesService.getUserProperties().getProperty(property_name) == 1) {
      [8, 7, 6, 5].forEach(idx => arr.splice(idx, 1));  // part4 + part3
    }
```

#### reorder the block 
```gs
  let elements = block.blocks[0].elements;
  elements.forEach(e => {
    if (e.type == 'rich_text_list' && e.style == 'ordered' && e.offset) {
      // 当你将剩下的 rich_text_list 类型块的 offset 字段都重置为0（或者干脆去掉 offset 字段），Slack API 接收到你的 payload 时，会自动把该列表的编号从 1 开始
      e.offset = 0;  
    }
  });
```


### 企业微信api相关
#### 更新标记哪些case已经被加急过了，后续就不会再掉进每次run的queue里了。只要涉及外部通知(除非是告知等候)，都会触发它
```gs
function add_tag(submit_time, reporter) {
  // 在form记录表中打上标记 用于区分哪些加急通知已经被完成
  var sha = SpreadsheetApp.getActiveSpreadsheet().getSheetById('2065846974')
  var ranges = sha.getRangeList(['A1:A', 'B1:B']).getRanges()
  var valuesA = ranges[0].getDisplayValues()
  var valuesB = ranges[1].getDisplayValues()
  var values = []
  for (var i = 0; i < valuesA.length; i++) {
    values.push([
      valuesA[i][0],  // A列的值
      valuesB[i][0]  // B列的值
    ])
  }
  // 倒序遍历所有行
  for (var i = values.length - 1; i >= 0; i--) {
    // 检查A列和B列是否匹配目标值
    if (values[i][0] == submit_time && values[i][1].toLowerCase() == reporter) {
      // 找到匹配行，更新C列的值
      sha.getRange(`L${i+1}`).setValue('YEAH');
      break;
    }
  }
};
```

#### 用来存kyc同学的手机号，这样bot可以ping到他。如果不及时更新的话，会有一个参数返回提醒他们去更新手机号
```gs
function get_phone_list(member_list, team_tag) {
  var preset_mapping = {
    'ec': {'NaN': ['17317234351', '17317234352']},
    'b2b': {'NaN': ['17317234353', '17317234354']},
    'ogs': {'NaN': ['17317234355', '17317234356']},
    'intl': {'NaN': ['17317234357', '17317234359']}
  }
  var kyc_list = SpreadsheetApp.getActiveSpreadsheet().getSheetById('1799752229').getRange('X:Y').getDisplayValues()  // kyc同学的名单和手机 用于企微@
  var kyc_phone_db = {}
  kyc_list.forEach(x => {
    kyc_phone_db[x[0]] = x[1].toString()
  })
  var unique_member_list = [...new Set(member_list)].filter(Boolean)  // assignee list 去重名单
  var phone_list = []
  var not_found_members = []  // 未在kyc_phone_db中找到的成员
  unique_member_list.forEach(x => {
    if (x == 'NaN') {
      if (team_tag == 'intl') {
        intl_entity.forEach(i => {
          phone_list.push(...preset_mapping[team_tag]['NaN'][i])
        })
      } else {
        phone_list.push(...preset_mapping[team_tag]['NaN'])  // unassigned, 使用扩展运算符将数组元素分别添加
      }
    } 
    else if (kyc_phone_db[x]) {
      phone_list.push(kyc_phone_db[x])
    } else {
      not_found_members.push(x)
    }
  })
  var unique_phone_list = [...new Set(phone_list)]  // 再去重一次
  var not_found_members = [...new Set(not_found_members)]

  return {
    'unique_phone_list': unique_phone_list, 
    'not_found_members': not_found_members
  }
};
```

#### 通知反馈
```gs
// 发给CN kyc - 企业微信 summary
  var bot_url = {
    'ec': 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=e15a9966-178b-4110-b07d-1ada1def8ff7',  // ~ec群 bot url
    'b2b': 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=e15a9966-178b-4110-b07d-1ada1def8ff7',  // ~b2b群 bot url
    'ogs': 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=e15a9966-178b-4110-b07d-1ada1def8ff7'  // ~ongoing群 bot url
  };
  [
    { data: expedite_ec, type: 'ec' },
    { data: expedite_b2b, type: 'b2b' },
    { data: expedite_ogs, type: 'ogs' }
  ].forEach(item => {
    if (item.data.length == 0) { return } // 如果没有数据则跳过
    // 设置每批消息包含的最大行数
    const MAX_ROWS_PER_MESSAGE = 5
    const totalBatches = Math.ceil(item.data.length / MAX_ROWS_PER_MESSAGE)
    for (let batchNum = 0; batchNum < totalBatches; batchNum++) {
      const startIdx = batchNum * MAX_ROWS_PER_MESSAGE
      const endIdx = Math.min((batchNum + 1) * MAX_ROWS_PER_MESSAGE, item.data.length)
      const batchData = item.data.slice(startIdx, endIdx)
      // 构建当前批次的消息
      let word = `### 🤖 加急Bot最新反馈 | [友情跳转](https://docs.google.com/spreadsheets/d/1dNSR_2llb0t-y3MBYA-i7_K-AI58uPPEio_BdO3802I/edit?gid=2065846974#gid=2065846974) | (${batchNum + 1}/${totalBatches}) | 表格支持左右滑动\n\n`
      word += '| SubmitTime | Reporter | Owner | AccountId/JiraKey | ClientName | Status | Assignee | RFI | OrgLevel2 | Reason |\n'
      word += '| :------ | :------ | :------ | :------ | :------ | :------ | :------ | :------ | :------ | :------ |\n'
      batchData.forEach(r => {
	// 防止reason写的过于啰嗦
	var truncatedReason = r.reason.length > 20 ? r.reason.substring(0, 17) + '...' : r.reason
	word += `| ${r.submit_time} | ${r.reporter} | ${r.bd_owner} | ${r.case_id_given} | ${r.biz_name} | ${r.case_level} | ${r.case_assignee} | ${r.rfi_status} | ${r.sf_org_l2} | ${truncatedReason} |\n`
      })
      // 发送当前批次到企业微信
      var payload = {
	'msgtype': 'markdown_v2',
	'markdown_v2': {
	  'content': word
	}
      }
      var options = {
	'method': 'post',
	'contentType': 'application/json',
	'payload': JSON.stringify(payload)
      }
      UrlFetchApp.fetch(bot_url[item.type], options)
      Utilities.sleep(1000)
    }
    // 在企业微信艾特人
    var assignee_list = item.data.map(i => {
      return i.case_assignee
    })
    var member_analysis = get_phone_list(member_list=assignee_list, team_tag=item.type)
    var word2 = `被@到的人请及时处理/帮忙分配case \n \n \n`
    if (member_analysis.not_found_members.length > 0) {
      word2 += `请team-leader及时将以下邮箱的手机号更新至 https://docs.google.com/spreadsheets/d/1dNSR_2llb0t-y3MBYA-i7_K-AI58uPPEio_BdO3802I/edit?gid=1799752229#gid=1799752229 上的X:Y列,否则加急信息无法精确告知至这些同学 \n <${member_analysis.not_found_members.join('>, <')}> \n \n \n \n`
    }
    var data2 = {
      'msgtype': 'text',
      'text': {
	'content': word2,
	'mentioned_mobile_list': member_analysis.unique_phone_list
      }
    }
    var options2 = {
      'method': 'post',
      'contentType': 'application/json',
      'payload': JSON.stringify(data2)
    }
    UrlFetchApp.fetch(bot_url[item.type], options2)
    Utilities.sleep(1000)
    ....

// 给SEA kyc - 企业微信 summary
function share_data_kyc_sea(data) {
  var expedite_sea = data.filter(kc => ['intl', 'uncategorised'].includes(kc.team_tag) && kc.scenario == 0)
    .sort((a, b) => {
      // 先按 case_type 升序排序
      if (a.case_type != b.case_type) {
        return a.case_type.localeCompare(b.case_type)
      }
      // 再按 case_level 升序排序
      if (a.case_level != b.case_level) {
        return a.case_level.localeCompare(b.case_level)
      }
      // 当 case_level & case_type 相同时，按 assignee 升序排序
      return (a.case_assignee || '').localeCompare(b.case_assignee || '')
    })
  if (expedite_sea.length == 0) { return } // 如果没有数据则跳过
  var word = `### 🤖[Pilot Running]加急Bot最新反馈 | [友情跳转](https://docs.google.com/spreadsheets/d/1dNSR_2llb0t-y3MBYA-i7_K-AI58uPPEio_BdO3802I/edit?gid=2065846974#gid=2065846974)\n\n`
  word += '| SubmitTime | Reporter | Owner | AccountId/JiraKey | ClientName | OwningEntity | CaseType | Status | Assignee | RFI | OrgLevel2 | Reason |\n'
  word += '| :------ | :------ | :------ | :------ | :------ | :------ | :------ | :------ | :------ | :------ | :------ | :------ |\n'
  expedite_sea.forEach(r => {
    // 防止reason写的过于啰嗦
    var truncatedReason = r.reason.length > 20 ? r.reason.substring(0, 17) + '...' : r.reason
    word += `| ${r.submit_time} | ${r.reporter} | ${r.bd_owner} | ${r.case_id_given} | ${r.biz_name} | ${r.owning_entity} | ${r.case_type} | ${r.case_level} | ${r.case_assignee} | ${r.rfi_status} | ${r.sf_org_l2} | ${truncatedReason} |\n`
  })
  // 发送到企业微信
  var data = {
    'msgtype': 'markdown_v2',
    'markdown_v2': {
      'content': word
    }
  }
  var options = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(data)
  }
  UrlFetchApp.fetch('https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=e15a9966-178b-4110-b07d-1ada1def8ff7', options)
  // 在企业微信艾特人
  var assignee_list = expedite_sea.map(i => {
    return i.case_assignee
  })
  var member_analysis = get_phone_list(member_list=assignee_list, team_tag='intl')
  var word2 = `被@到的人请及时处理/帮忙分配case \n \n \n`
  if (member_analysis.not_found_members.length > 0) {
    word2 += `请team-leader及时将以下邮箱的手机号更新至 https://docs.google.com/spreadsheets/d/1dNSR_2llb0t-y3MBYA-i7_K-AI58uPPEio_BdO3802I/edit?gid=1799752229#gid=1799752229 ,否则加急信息无法精确告知至这些同学 \n <${member_analysis.not_found_members.join('>, <')}> \n \n \n \n`
  }
  var data2 = {
    'msgtype': 'text',
    'text': {
      'content': word2,
      'mentioned_mobile_list': member_analysis.unique_phone_list
    }
  }
  var options2 = {
    'method': 'post',
    'contentType': 'application/json',
    'payload': JSON.stringify(data2)
  }
  UrlFetchApp.fetch('https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=e15a9966-178b-4110-b07d-1ada1def8ff7', options2)  // ~sea slack channel url
};
```


### how to check the bigquery refresh status  
```gs
  // check the refresh status
  sh_accountbase.getRange('A1').activate()
  var bq_params = sh_accountbase.getCurrentCell().getDataSourceTables()[0].getStatus()

  var bq_status = bq_params.getExecutionState()
  if (bq_status != 'SUCCESS') {
    slackapp_error_alert(
      slackurl=url, 
      bq_status=bq_status, 
      error_msg=bq_params.getErrorMessage(), 
      last_refresh_time=bq_params.getLastExecutionTime(), 
      last_success_time=bq_params.getLastRefreshedTime()
    )
    return 0
  }

 // refreshDataAndContinue
  var shc = SpreadsheetApp.getActiveSpreadsheet().getSheetById('1679686918')
  shc.getRange('H2').activate()
  SpreadsheetApp.enableAllDataSourcesExecution()
  try {
    var dst = shc.getCurrentCell().getDataSourceTables()[0]
    dst.forceRefreshData()
    dst.waitForCompletion(200)
    // 刷新成功，执行后续操作
    Logger.log('数据源刷新成功')
    ... 正常操作
  } catch (error) {
    word = `数据源刷新失败: ${error.message}`
    ...
  }
```


### how to work with filter
#### 场景1 前端筛选效果
```gs
const filter = region_sheet.getFilter()
// if there is an existing filter in the tab, it should be released, or it would jump out error
if (filter != null) {
filter.remove()
}

// filter criteria
let criteria_1 = SpreadsheetApp.newFilterCriteria().whenTextEqualTo('TRUE').build()
let filter_1 = region_sheet.getRange('A1:R').createFilter()
filter_1.setColumnFilterCriteria(18, criteria_1)

// paste the filter result into an temporary tab
let helper_tab = SpreadsheetApp.getActiveSpreadsheet().insertSheet('Temporary')
region_sheet.getRange('A1:R').copyTo(helper_tab.getActiveRange(), SpreadsheetApp.CopyPasteType.PASTE_VALUES, false)

let raw_content = helper_tab.getRange('A1:R'+getLastRow(helper_tab,'A:A')).getDisplayValues()
	      .map(
		function(row) {
		      var intValue = parseInt(row[16]);
		      if (!isNaN(intValue)) { // Check if the parsed value is not a NaN before assigning
			row[16] = intValue;
		      }
		      return row;
		}
	      )
	      .sort(function(a, b) {
		return b[16] - a[16];
	      })

raw_content.shift()  // return and remove the first element from the array
...
region_sheet.getFilter().remove()
```

#### 场景2 背后筛选并涉及剪切移送
```gs
function processUserInput(userInput, buttonType) {
  if (userInput == null ) {
    // l can define the schedule func here
    var user_list = ['testaccountid1', 'testaccountid2']
  } else {
    var user_list = userInput.split('\n')
  }
  if (buttonType === 'buttonPR') {
    var from_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Periodical Review (PR)')
  } else {
    var from_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Material Trigger (MT)')
  }
  const to_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Recycle Bin')

  // check the id existence, and generate the notification content
  var noti_part = []
  var bd_list = []
  user_list.forEach(
    r => {
      var id_list = from_sheet.getRange('B:B').getDisplayValues().flat()
      let find = id_list.indexOf(r)
      if (find == -1 || r==null || r=='') {
        SpreadsheetApp.getUi().alert('❗️'+r+' is not in the list')
      } else {
        var raw_data = from_sheet.getRange('A1:G'+getLastRow(from_sheet,'A:A')).getDisplayValues()
        noti_part.push({
          clientName: raw_data[find][0],
          xxId: raw_data[find][1],
          type: raw_data[find][2],
          accountOwner: raw_data[find][3],
          customerSegment: raw_data[find][4],
          orgL2: raw_data[find][5],
          addTag: raw_data[find][6],
          delTag: 'Removed on ' + Utilities.formatDate(new Date(),"GMT+8","yyyy-MM-dd"),
        })
        bd_list.push(raw_data[find][3]) // update the to list[bd]
        // delete the id row from current block list
        from_sheet.deleteRow(find+1)
        // set the removed id row info into archived tab
        to_sheet.getRange(getLastRow(to_sheet,'A:A')+1, 1, 1, Object.keys(noti_part[0]).length) // Object.keys(obj) ：会返回对象所有可枚举“属性名”组成的一个数组
        // push进数组，用 noti_part[0].length; push进对象，用 Object.keys(noti_part[0]).length
        .setValues([[
          noti_part[noti_part.length-1].clientName,
          noti_part[noti_part.length-1].xxId,
          noti_part[noti_part.length-1].type,
          noti_part[noti_part.length-1].accountOwner,
          noti_part[noti_part.length-1].customerSegment,
          noti_part[noti_part.length-1].orgL2,
          noti_part[noti_part.length-1].addTag,
          noti_part[noti_part.length-1].delTag,
        ]])
        SpreadsheetApp.getUi().alert('✅'+r+' has been transferred to be archived')
      }
    }
  )
}
```


### Google Doc相关
#### update the table in google doc
```gs
function updateAllTables(url) {
  var body = DocumentApp.openByUrl(url).getBody();
  var ab_info = ab_extractDetails()
  var tables = body.getTables();
  for (var t = 0; t < tables.length; t++) {
    var table = tables[t];
    for (var r = 0; r < table.getNumRows(); r++) {
      var row = table.getRow(r);
      for (var c = 0; c < row.getNumCells(); c++) {
        var cell = row.getCell(c);
        var lines = cell.getText().split('\n');
        for (var i = 0; i < lines.length - 1; i++) {
          if (lines[i] == 'Company’s full legal name:') {
            lines[i + 1] = ab_info.companyNameEn
          }
          else if (lines[i] == 'Head quarter’s address:') {
            lines[i + 1] = ab_info.streetAddressEnglish
          }
          else if (lines[i] == 'City:') {
            lines[i + 1] = ab_info.cityEnglish
          }
          else if (lines[i] == 'State/Province:') {
            lines[i + 1] = ab_info.stateEnglish
          }
          else if (lines[i] == 'Country:') {
            lines[i + 1] = ab_info.countryCode
          }
          else if (lines[i] == 'Postal Code:') {
            lines[i + 1] = ab_info.postcode
          }
          else if (lines[i] == 'Business Phone #:') {
            lines[i + 1] = ab_info.phoneNumber
          }
          else if (lines[i] == 'Government Tax I.D. or local equivalent:') {
            lines[i + 1] = ab_info.businessRegistrationNumber
          }
          else if (lines[i] == 'Web Address:') {
            lines[i + 1] = ab_info.verifiedUrl
          }
          else if (lines[i] == 'Business model:') {
            lines[i + 1] = ab_info.descriptionOfGoodsOrServices
          }
          else if (lines[i] == 'Name of Company') {
            lines[i] = `Name of Company  _ ${ab_info.companyNameEn} _`
          }


          cell.setText(lines.join('\n'));
        }

        Logger.log('表格%d 行%d 列%d 内容: %s', t+1, r+1, c+1, row.getCell(c).getText());
      }
    }
  }
}
```


### quality sampling  
#### get random samples - method1
```gs
function getRandomTopElements(list, numElements) {
  // 1. Create an array of objects with each item and a random number
  var itemsWithRandom = list.map(function (item) {
    return {
      originalItem: item,
      randomValue: Math.random()
    };
  });

  // 2. Sort this array based on the random number
  itemsWithRandom.sort(function (a, b) {
    return a.randomValue - b.randomValue;
  });

  // 3. Extract the first `numElements` items from the sorted array
  // and map to get only the original items (not the random numbers)
  var selectedItems = itemsWithRandom.slice(0, numElements).map(function (element) {
    return element.originalItem;
  });

  // 4. Return these selected items
  return selectedItems;
}
```

#### get random samples - method2
```gs
function sampleRandomRows(rows, count) {
  // 如果候选行数少于需要抽取的数量，则全部返回
  if (rows.length <= count) {
    return rows;
  }
  // 洗牌算法
  for (let i = rows.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [rows[i], rows[j]] = [rows[j], rows[i]];
  }
  // 返回前count个
  return rows.slice(0, count);
}
```

#### 根据region的案例数量确定抽样数量的函数
```gs 
function determineRegionSampleSize(caseCount) {
  // 如果案例总数少于25，则全部抽取
  if (caseCount < 25) {
    return caseCount;
  }
  // 根据案例数量确定抽样数量
  if (caseCount >= 5000) {
    return 50;
  } else if (caseCount >= 4000) {
    return 45;
  } else if (caseCount >= 3000) {
    return 40;
  } else if (caseCount >= 2000) {
    return 35;
  } else if (caseCount >= 1000) {
    return 30;
  } else if (caseCount >= 500) {
    return 25;
  } else {
    return 25; // 最少抽25个
  }
}
```

#### 根据记录数量确定抽样百分比
```gs
function determineSamplePercentage(recordCount) {
  if (recordCount > 1000) {
    return 0.05; // 5%
  } else if (recordCount > 500) {
    return 0.10; // 10%
  } else if (recordCount > 100) {
    return 0.15; // 15%
  } else if (recordCount > 50) {
    return 0.50; // 50%
  } else {
    return 1.0; // 100%，即全部抽取
  }
}

function determineRegionSampleSize_rt(caseCount) {
  const percentage = determineSamplePercentage(caseCount);
  const sampleSize = Math.round(caseCount * percentage);
  
  // 确保至少抽取一个样本（如果有记录的话）
  return caseCount > 0 ? Math.max(1, sampleSize) : 0;
}
```

#### 针对group分配样本数量的循环滚动抽样代码
```gs
// 将groupsInEntity转换为数组并按案例数量排序（从高到低）
// 在代码中，`Object.entries(groupsInEntity)` 是将 `groupsInEntity` 对象转换为这样的键值对数组，每个数组项包含 group 名称和对应的 count 值。
const groupEntries = Object.entries(groupsInEntity).map(([group, count]) => ({
  group, 
  count
})).sort((a, b) => b.count - a.count); // 按数量从大到小排序

// 初始化各group的样本数
const groupSamples = {};
groupEntries.forEach(entry => {
  groupSamples[entry.group] = 0;
});

// 使用滚动方式分配样本，确保优先考虑数量多的group
let allocatedSamples = 0;

// 先确保每个group至少有1个样本
for (const entry of groupEntries) {
  if (allocatedSamples < entitySamples) {
    groupSamples[entry.group] = 1;
    allocatedSamples++;
  } else {
    break;
  }
}

// 如果还有剩余样本配额，进行滚动抽样分配
while (allocatedSamples < entitySamples) {
  let sampleAdded = false;
  
  // 循环遍历group，每组增加1个样本
  for (const entry of groupEntries) {
    // 如果组内还有足够的案例可抽样（已抽样本数<组内总案例数）
    if (groupSamples[entry.group] < entry.count && allocatedSamples < entitySamples) {
      groupSamples[entry.group]++;
      allocatedSamples++;
      sampleAdded = true;
    }
    
    // 如果已达到entity样本配额上限，跳出循环
    if (allocatedSamples >= entitySamples) {
      break;
    }
  }
  
  // 如果本轮没有任何组能增加样本，则跳出循环
  // 这种情况发生在所有组的样本数都已经等于其案例数
  if (!sampleAdded) {
    break;
  }
}

// 输出日志
for (const group in groupSamples) {
  const groupCount = groupsInEntity[group];
  Logger.log(`current group: ${group}, total amount: ${groupCount}, sample size: ${groupSamples[group]}`);
}
```

#### 优先抽取RFI字段为true的记录，然后再随机抽取剩余所需数量的功能
```gs
const rfiTrueRows = candidateRows.filter(item => item.rowInfo[11] === 'TRUE');
const rfiFalseRows = candidateRows.filter(item => item.rowInfo[11] !== 'TRUE');
...
// 结果数组
let selectedRows = [];

// 首先尽可能添加RFI=true的记录
if (rfiTrueRows.length > 0) {
// 如果RFI=true的记录足够，只取所需数量
// 如果不够，全部取用
const countFromRfiTrue = Math.min(sampleCount, rfiTrueRows.length);
selectedRows = rfiTrueRows.slice(0, countFromRfiTrue);
}

// 如果还需要更多记录，从RFI=false的记录中取
const remainingCount = sampleCount - selectedRows.length;
if (remainingCount > 0 && rfiFalseRows.length > 0) {
selectedRows = selectedRows.concat(rfiFalseRows.slice(0, remainingCount));
}

return selectedRows;
```

#### 依照某个字段来做比例抽样
```gs
function stratifyByCRR(rows, n, crrIdx) {
  // 返回rows中n个，按crr分高/中/低比例分层采样（不足优先高/中，再补低）
  if (n <= 0 || !rows.length) return [];
  const total = rows.length;
  let high = [], medium = [], low = [];
  rows.forEach(r => {
    const v = String(r[crrIdx]).toUpperCase();
    if (v == 'HIGH') high.push(r);
    else if (v == 'MEDIUM') medium.push(r);
    else low.push(r);
  });
  let nh = Math.ceil(high.length * n / total);
  let nm = Math.ceil(medium.length * n / total);
  let nl = n - nh - nm;
  let final = [];
  final = final.concat(sampleRandomRows(high, nh));
  final = final.concat(sampleRandomRows(medium, nm));
  final = final.concat(sampleRandomRows(low, nl));
  // 确保不会超出n
  while (final.length > n) final.pop();
  return final;
}
```

#### 涉及 按层次，按比例，有上限，有优先级 的抽样
```gs
// regionRows 用于存放每个 region 下的全部数据行
let regionRows = {};
rows.forEach(r => {
  const region = r[pos_region];
  if (!regionRows[region]) {
    regionRows[region] = [];
  }
  regionRows[region].push(r);
});

// entityRows 用于存放每个 region 下每个 entity 的全部数据行
let entityRows = {};
rows.forEach(r => {
  const region = r[pos_region];
  const entity = r[pos_entity];
  if (!entityRows[region]) {
    entityRows[region] = {};
  }
  if (!entityRows[region][entity]) {
    entityRows[region][entity] = [];
  }
  entityRows[region][entity].push(r);
});

let finalSamples = []; // 最终的采样结果

Object.keys(entityRows).forEach(region => {
  // 1. 统计 region 下所有 entity 的 stpTrue 和 scaTeamTrue 总数
  let regionStpTrueCount = 0, regionScaTeamTrueCount = 0;
  Object.keys(entityRows[region]).forEach(entity => {
    const groupRows = entityRows[region][entity];
    regionStpTrueCount += groupRows.filter(r => r[pos_stp]).length;
    regionScaTeamTrueCount += groupRows.filter(r => !r[pos_stp] && r[pos_sca]).length;
  });

  // 2. 设置 region 级别的 stpTrue 上限（部分 region 可以设为20, 其余为30），以及 scaTeamTrue 上限(10)
  let maxRegionStpTrue;
  if (['ANZ', 'EMEA'].includes(region)) {
    maxRegionStpTrue = Math.min(20, regionStpTrueCount);
  } else {
    maxRegionStpTrue = Math.min(30, regionStpTrueCount);
  }
  const maxRegionScaTeamTrue = Math.min(10, regionScaTeamTrueCount);

  // 记录 region 级目标值，便于日志和调试
  Logger.log(
    `处理region: ${region}, 总数: ${regionRows[region].length}, 抽样: ${determineRegionSampleSize(regionRows[region].length)}`
  );

  Object.keys(entityRows[region]).forEach(entity => {
    const groupRows = entityRows[region][entity];
    const rowsCount = groupRows.length;

    // 3. 先计算本 entity 的目标采样数，按该 entity 在 region 下的数据行数占比来分配
    const sampleTarget = Math.ceil(
      determineRegionSampleSize(regionRows[region].length)
      * (rowsCount / regionRows[region].length)
    );
    Logger.log(
      `处理region: ${region}, entity: ${entity}, 总数: ${rowsCount}, 抽样: ${sampleTarget}`
    );
    if (sampleTarget == 0) { return 0; }

    // 4. 获取该 entity 下的 stpTrue 行、stpFalse行
    const stpTrueRows = groupRows.filter(r => r[pos_stp]);
    const stpFalseRows = groupRows.filter(r => !r[pos_stp]);
    const stpTrueCount = stpTrueRows.length;
    const stpFalseCount = stpFalseRows.length;

    // 5. 本 entity 下 stpTrue 配额，按 entity 的 stpTrue 数在 region 的stpTrue总数中的占比来分配 region 上限
    //    再受自身可分配数&理论总采样数共同约束
    let sampleTarget_stpTrue = Math.min(
      regionStpTrueCount == 0 ? 0 : Math.floor(maxRegionStpTrue * (stpTrueCount / regionStpTrueCount)),
      sampleTarget,
      stpTrueCount
    );

    // 6. 剩余样本先分配给 stpFalse
    let sampleTarget_stpFalse = sampleTarget - sampleTarget_stpTrue;
    if (stpFalseCount < sampleTarget_stpFalse) {
      // 若stpFalse不足，把多余 quota 移给 stpTrue
      sampleTarget_stpTrue += (sampleTarget_stpFalse - stpFalseCount);
      sampleTarget_stpFalse = stpFalseCount;
      sampleTarget_stpTrue = Math.min(
        sampleTarget_stpTrue,
        stpTrueCount,
        sampleTarget
      );
    }

    // 7. stpTrue样本抽取
    const stpTrueSamples = stratifyByCRR(stpTrueRows, sampleTarget_stpTrue, pos_crr);

    // 8. stpFalse 再按 sca 分类
    const scaTeamTrueRows = stpFalseRows.filter(r => r[pos_sca]);
    const scaTeamFalseRows = stpFalseRows.filter(r => !r[pos_sca]);
    const scaTeamTrueCount = scaTeamTrueRows.length;

    // 9. scaTeamTrue配额：一样按 entity 的 scaTeamTrue 数量在 region scaTeamTrue 总数中的占比分配 region quota
    let sampleTarget_scaTeamTrue = Math.min(
      regionScaTeamTrueCount == 0 ? 0 : Math.floor(maxRegionScaTeamTrue * (scaTeamTrueCount / regionScaTeamTrueCount)), 
      sampleTarget_stpFalse, 
      scaTeamTrueCount
    );

    // 10. scaTeamFalse 剩余 quota 统统分给它
    let sampleTarget_scaTeamFalse = sampleTarget_stpFalse - sampleTarget_scaTeamTrue;
    sampleTarget_scaTeamFalse = Math.min(sampleTarget_scaTeamFalse, scaTeamFalseRows.length);

    // 11. 抽样
    const scaTeamTrueSamples = stratifyByCRR(scaTeamTrueRows, sampleTarget_scaTeamTrue, pos_crr);
    const scaTeamFalseSamples = stratifyByCRR(scaTeamFalseRows, sampleTarget_scaTeamFalse, pos_crr);

    // 12. 合并本 entity 的所有样本到最终集合
    finalSamples = finalSamples
      .concat(stpTrueSamples)
      .concat(scaTeamTrueSamples)
      .concat(scaTeamFalseSamples);
  });
});
```

#### 完整实操样例-1
```gs
随机抽样并登表 - qa sampling 
function sampleCases() {
  // 基本参数
  var dateinfo = new Date();
  dateinfo.setMonth(dateinfo.getMonth() - 1);  // set the month to the previous 
  dateinfo.setDate(1);  // set the date to the first day of the month
  var monthbatch = Utilities.formatDate(dateinfo, 'GMT+8', 'YYYY-MM-dd');
  var accum = 0;
  
  // 获取数据
  const sheet_pool = SpreadsheetApp.getActiveSpreadsheet().getSheetById(1356321158);
  const sheet_ea = SpreadsheetApp.getActiveSpreadsheet().getSheetById(0);
  const sheet_au = SpreadsheetApp.getActiveSpreadsheet().getSheetById(989690082);
  const sheet_eu = SpreadsheetApp.getActiveSpreadsheet().getSheetById(1724512175);
  const sheet_us = SpreadsheetApp.getActiveSpreadsheet().getSheetById(1923723751);
  const data = sheet_pool.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1); // 移除标题行, 正文数据
  
  // 定义常用列索引
  const pos_region = headers.indexOf('region');
  const pos_entity = headers.indexOf('owning_entity');
  const pos_group = headers.indexOf('ref_rule_group');
  
  // 统计数据
  const regionCounts = {};
  const entityCountsByRegion = {};
  const groupCountsByEntity = {};
  
  // 初始分类统计，知晓各个region entity group的数量分布
  rows.forEach((row, index) => {
    const region = row[pos_region];
    const entity = row[pos_entity];
    const group = row[pos_group];
    // 数region
    regionCounts[region] = (regionCounts[region] || 0) + 1;
    // 数entity
    if (!entityCountsByRegion[region]) {
      entityCountsByRegion[region] = {};
    }
    entityCountsByRegion[region][entity] = (entityCountsByRegion[region][entity] || 0) + 1;
    // 数group
    const entityKey = `${region}|${entity}`;
    if (!groupCountsByEntity[entityKey]) {
      groupCountsByEntity[entityKey] = {};
    }
    groupCountsByEntity[entityKey][group] = (groupCountsByEntity[entityKey][group] || 0) + 1;
  });
  
  // 计算分配数量并抽样
  const sampledRows = [];
  const sampledIndices = new Set(); // 用于记录已抽样的行索引, 比{}性能更优 更清晰
  // 第一层 - region
  for (const region in regionCounts) {
    // 根据region的案例数量动态确定抽样数量
    const regionCaseCount = regionCounts[region];
    const regionSampleTarget = determineRegionSampleSize(regionCaseCount);
    Logger.log(`处理region: ${region}, 总数: ${regionCaseCount}, 抽样: ${regionSampleTarget}`);
    // 第二层 - owning entity
    const entitiesInRegion = entityCountsByRegion[region];
    const samplesForRegion = [];
    // 计算每个entity应抽取的样本数
    for (const entity in entitiesInRegion) {
      const entityCount = entitiesInRegion[entity];
      const entityRatio = entityCount / regionCounts[region];
      let entitySamples = Math.round(regionSampleTarget * entityRatio);
      // 确保至少抽取1个样本，如果比例大于0
      if (entityRatio > 0 && entitySamples == 0) {
        entitySamples = 1;
      }
      Logger.log(`Entity: ${entity}, 数量: ${entityCount}, 比例: ${entityRatio}, 分配样本数: ${entitySamples}`);
      // 该entity中的所有group
      const entityKey = `${region}|${entity}`;
      const groupsInEntity = groupCountsByEntity[entityKey] || {};
      const groupSamples = {};
      // let totalGroupSamples = 0;
      // 第三层 - group of rule name
      for (const group in groupsInEntity) {
        const groupCount = groupsInEntity[group];
        const groupRatio = groupCount / entityCount;
        let groupSampleCount = Math.round(entitySamples * groupRatio);
        // 确保至少抽取1个样本，如果比例大于0
        if (groupRatio > 0 && groupSampleCount == 0) {
          groupSampleCount = 1;
        }
        groupSamples[group] = groupSampleCount;
        // totalGroupSamples += groupSampleCount;
        Logger.log(`Group: ${group}, 数量: ${groupCount}, 比例: ${groupRatio}, 分配样本数: ${groupSampleCount}`);
      }
      
      /** 先不考虑
      // 如果group样本数和entity样本数不一致
      if (totalGroupSamples != entitySamples) {
        Logger.log(`需要调整样本数: ${totalGroupSamples} -> ${entitySamples}`);
        // 简单调整策略：从最大的group中增减
        const groupsSorted = Object.keys(groupSamples).sort((a, b) => groupSamples[b] - groupSamples[a]);
        const diff = entitySamples - totalGroupSamples;
        groupSamples[groupsSorted[0]] += diff;
      }
      */
      
      // 从每个group中抽取样本
      for (const group in groupSamples) {
        const sampleCount = groupSamples[group];
        if (sampleCount <= 0) continue;
        // 找出所有符合条件的行
        const candidateRows = rows.map((rowInfo, idxTag) => 
          ({rowInfo: rowInfo, idxTag: idxTag})  // 小括号不能省略，否则会被解析为带有标签(label)的代码块，而不是返回对象，导致语法错误
        ).filter(item => 
          item.rowInfo[pos_region] == region && 
          item.rowInfo[pos_entity] == entity && 
          item.rowInfo[pos_group] == group &&
          !sampledIndices.has(item.idxTag)
        );
        // 随机抽取指定数量的行
        const selected = sampleRandomRows(candidateRows, sampleCount);
        var addrowdatas = [];
        // 添加到结果并记录已抽样的行索引
        selected.forEach(item => {
          samplesForRegion.push(item.rowInfo);
          sampledIndices.add(item.idxTag);
          var accum_code = Utilities.formatString('%4s',String(accum));
          for (var j=1; j<100; j++) {
            accum_code = accum_code.replace(' ','0')
            if (!accum_code.includes(' ')) {
              break;
            }
          }
          var team = item.rowInfo[10];
          var rfitag = (item.rowInfo[11] == 'TRUE' ? 'Y' : 'N');
          var qaid =  'RT' + Utilities.formatDate(dateinfo, 'GMT+8', 'YYMM') + accum_code + rfitag + team;  // QA样本编号 'RT'+年后两位+月两位+四位累增编码+RFI标记+teamtag
          var type = 'Real-Time';
          var caseid = item.rowInfo[0];
          var entity = item.rowInfo[7];
          var l1owner = item.rowInfo[2];
          var l2owner = item.rowInfo[3];
          var l3owner = item.rowInfo[4];
          var rulename = item.rowInfo[5];
          var addrowdata = [monthbatch, qaid, entity, type, caseid, l1owner, l2owner, l3owner, rulename];
          addrowdatas.push(addrowdata);
          accum++;
        });
        Logger.log(`从Group[${group}]抽取了${selected.length}个样本`);
        Logger.log(addrowdatas);
        //判断region 决定去哪张sheet贴
        if(region == 'ANZ') {
          var to_sheet = sheet_au;
        } 
        else if(region == 'EMEA') {
          
          var to_sheet = sheet_eu;
        }
        else if(region == 'HK&SG&MY') {
          
          var to_sheet = sheet_ea;
        }
        else if(region == 'US') {
          
          var to_sheet = sheet_us;
        }
        to_sheet.getRange(getLastRow(to_sheet,'A:A')+1, 1, addrowdatas.length, addrowdatas[0].length).setValues(addrowdatas);
      }
    }
    sampledRows.push(...samplesForRegion);
    Logger.log(`Region[${region}]总共抽取了${samplesForRegion.length}个样本`);
  }
  
  return sampledRows;
}
```

---

### others
#### 根据传入的货币代码（比如 'USD', 'CNY', 'HKD'），查找表中登记的所有该货币的节假日日期，返回已格式化好的yyyy-MM-dd字符串数组。
```gs
function getHolidays(ccy) {
  var ss = SpreadsheetApp.openById('1kjZJU7nnY4xI5uy_tNifYcpbR-IDnPQTdktEFdh7IQs').getSheetByName('Static holiday data')
  var rangelist = ss.getRangeList(['B1:B', 'F1:F4'])
  var allValues = rangelist.getRanges().map(function (range) {
    return range.getValues().flat(); // Retrieves the values for each individual range
  })

  var holiday_list = []
  allValues[0].forEach(
    (r, n) => {
      r == ccy ? holiday_list.push(String(allValues[1][n])) : {}
    }
  )

  for (i in holiday_list) {

    let year = holiday_list[i].substring(0, 4)
    let month = holiday_list[i].substring(4, 6)
    let day = holiday_list[i].substring(6)
    holiday_list[i] = Utilities.formatDate(new Date(year, month - 1, day), 'GMT+8', 'yyyy-MM-dd')

  }

  // Logger.log(holiday_list.includes(Utilities.formatDate(new Date('6/12/2024 0:05:55'),'GMT+8', 'yyyy-MM-dd')))
  return holiday_list
}
```

#### 纯数字转化为逗号分隔的格式
```gs
function formatNumberWithTwoDecimals(number) {
  var number = Number(number)

  var options = {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  };
  var formattedNumber = number.toLocaleString('en-US', options);

  return formattedNumber
  // Logger.log(formattedNumber); // Output will be '1,234,567.89'
}
```

#### ensure that the previous code's output and/or effects are written to the spreadsheet before continuing
```gs
SpreadsheetApp.flush()
Utilities.sleep(50)
```

#### 收集后统一添加数据
```gs
var addrowdatas = []
var addrowdata = [monthbatch, qaid, entity, casetype, match_result, nsid, l1owner, l2owner, l3owner, alert]
addrowdatas.push(addrowdata)
to_sheet.getRange(getLastRow(to_sheet, 'A:A') + 1, 1, addrowdatas.length, 10).setValues(addrowdatas)
```

#### 将文本dic转换为json数组
```gs
function convertStringToJsonArray(your_string_dictionary) {
  var jsonString = '[' + your_string_dictionary + ']'; // Concatenate your string dictionaries into a valid JSON array string
  jsonString = jsonString.replace(/\n/g, ""); // Remove newline characters if they are part of the string
  
  // Parse the valid JSON string to a JavaScript array of objects
  var jsonArray;
  try {
    jsonArray = JSON.parse(jsonString);
  } catch (e) {
    Logger.log('Error parsing JSON: ' + e);
    return; // Exit the function if parsing fails
  }
  
  // Do something with the jsonArray
  // Logger.log(jsonArray);
  
  return jsonArray;
}
```

#### 加总某迭代数组
```gs
  const region_order = ['GC', 'HK&SEA', 'ANZ', 'EMEA', 'NA'];
  let ranges = ss.getRangeList(['G16:K16', 'G22:K22', 'G28:K28', 'G34:K34', 'G40:K40']).getRanges();  // ['GC', 'HK&SEA', 'ANZ', 'EMEA', 'NA']
  let region_values = ranges.map(r => r.getValues()[0]);
  const obd_backlog_summary = {};
  region_order.forEach((region, idx) => {
    let r = region_values[idx];
    obd_backlog_summary[region] = {
      TOTAL: r.reduce((previous, current) => previous + current, 0),
      TWO_THREE: r[0],
      THREE_FIVE: r[1],
      FIVE_MORE: r[2] + r[3] + r[4]
    }
  });
```

#### 分类汇总多个tab各自的内容（统一标准）
```gs
  const ss1 = SpreadsheetApp.openById('1CeR0i653Z_GFxplaYlkh--Fni78ozvMkFx18emV6kCo').getSheetById(1083627185);  // #1 - CLE in non-responsive WL 
  const ss2 = SpreadsheetApp.openById('1CeR0i653Z_GFxplaYlkh--Fni78ozvMkFx18emV6kCo').getSheetById(1029548490);  // #2 - 115 in review cases
  const ss3 = SpreadsheetApp.openById('1CeR0i653Z_GFxplaYlkh--Fni78ozvMkFx18emV6kCo').getSheetById(268802701);  // #3 - Dormancy in review cases
  let ssc1 = ss1.getRange('A3:Z').getDisplayValues();
  let ssc2 = ss2.getRange('A3:Z').getDisplayValues();
  let ssc3 = ss3.getRange('A3:Z').getDisplayValues();
  const ss1_headers = ssc1[0];
  const ss2_headers = ssc2[0];
  const ss3_headers = ssc3[0];
  ssc1 = ssc1.slice(1);
  ssc2 = ssc2.slice(1);
  ssc3 = ssc3.slice(1);
  var ssc1_class = {ANZ: [], EMEA: [], NA: [], GC: [], 'HK&SEA': []};
  var ssc2_class = {ANZ: [], EMEA: [], NA: [], GC: [], 'HK&SEA': []};
  var ssc3_class = {ANZ: [], EMEA: [], NA: [], GC: [], 'HK&SEA': []};
  const combo = [
    {cls: ssc1_class, data: ssc1, headers: ss1_headers},  // 分类后的原数据，原数据，原数据的表头
    {cls: ssc2_class, data: ssc2, headers: ss2_headers},
    {cls: ssc3_class, data: ssc3, headers: ss3_headers},
  ];
  for (let {cls, data, headers} of combo) {
    for (let i = 0; i < data.length; i++) {
      const entity = data[i][headers.indexOf('owningEntity')];
      if (['AIRWALLEX_AU', 'AIRWALLEX_NZ'].includes(entity)) {
        cls.ANZ.push(data[i]);
      } else if (['AIRWALLEX_UK', 'AIRWALLEX_NL', 'AIRWALLEX_LT'].includes(entity)) {
        cls.EMEA.push(data[i]);
      } else if (['AIRWALLEX_US', 'AIRWALLEX_CA'].includes(entity)) {
        cls.NA.push(data[i]);
      } else if (['AIRWALLEX_HK', 'AIRWALLEX_SG', 'AIRWALLEX_MY'].includes(entity)) {
        cls.GC.push(data[i]);
      }
    }
  }
  let ogs_backlog_summary = {SCENARIO_ONE: ssc1_class, SCENARIO_TWO: ssc2_class, SCENARIO_THREE: ssc3_class};
```
