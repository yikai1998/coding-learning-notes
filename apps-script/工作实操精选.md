### get last row number from a range  
```gs
function getLastRow(sheet,rangeString){
  var rng = sheet.getRange(rangeString).getValues();
  var lrindex;
  for(var i = rng.length-1;i>=0;i--){
    lrindex = i
    if(!rng[i].every(function(c){ return c == ""; })){
      break;
    }
  }
  return lrindex +1;
}
```

---

### how to set the menu in top bar  
```gs
function onOpen() {
  var subMenu1 = SpreadsheetApp.getUi().createMenu('Notification')
              .addItem('T60/30_Report', 'send_3060')
  var subMenu2 = SpreadsheetApp.getUi().createMenu('Reminder List')
              .addItem('T60 Block List Update', 'transferPR_T60')
              .addItem('T30 Alert List Replace', 'transferPR_T30')
  var subMenu_pr = SpreadsheetApp.getUi().createMenu('Periodic Review')
              .addSubMenu(
                SpreadsheetApp.getUi().createMenu('Notification').addItem('T60/30_Report', 'send_3060')
              )
              .addSeparator()
              .addSubMenu(
                SpreadsheetApp.getUi().createMenu('Reminder List')
                .addItem('T60 Block List Update', 'transferPR_T60')
                .addItem('T30 Alert List Replace', 'transferPR_T30')
              )
  var subMenu_mt = SpreadsheetApp.getUi().createMenu('Material Trigger')
              .addSubMenu(
                SpreadsheetApp.getUi().createMenu('Notification').addItem('T30/20_Report', 'send_2030')
              )
              .addSeparator()
              .addSubMenu(
                SpreadsheetApp.getUi().createMenu('Reminder List')
                .addItem('T30 Block List Update', 'transferMT_T30')
              )
  SpreadsheetApp.getUi().createMenu('🐢 SmartFunctions')
      .addSubMenu(subMenu_pr)
      .addSeparator()
      .addSubMenu(subMenu_mt)
      .addSeparator()
      .addItem('How to use', 'instruction')
      .addToUi();
}
```

---

### interact with jira  
#### get tickets queue list, with fields required  
```gs
function fetchJiraData() {
    var jiraUrl = 'https://airwallex.atlassian.net/rest/api/3/search'
    var username = 'ben.chen@airwallex.com'
    var apiToken = 'xxx'
    
    var jqlQuery = 'project = OPS_KYC and issuetype IN ("Ongoing KYC Review Request", "Periodic Review") and (updated > "2024/10/15 08:00" or status NOT IN ("REVIEW COMPLETED - PASSED", "REVIEW COMPLETED - NO NEEDED", "CLOSED PER COMMERCIAL TEAM REQUEST", "REVIEW COMPLETED - KICKOFF OFFBOARDING")) ORDER BY created ASC'
    var maxResults = 100 // Max results per request
    var startAt = 0      // Pagination start index
    var issues = []
    var total = Infinity
    var batch = 1
    
    var options = {
        'method': 'get',
        'headers': {
            'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + apiToken)
        }
    }

    while (startAt < total) {
        var response = UrlFetchApp.fetch(jiraUrl + '?jql=' + encodeURIComponent(jqlQuery) + '&maxResults=' + maxResults + '&startAt=' + startAt, options)
        var data = JSON.parse(response.getContentText())

        issues = issues.concat(data.issues)
        total = data.total // Total number of issues to fetch
        startAt += maxResults // Move to the next batch
        Logger.log('>> Batch %s', batch)
        batch += 1
    }

    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('After20241015')
    var result = [['Client Legal Entity ID',	'Issue Type',	'Key',	'Summary',	'Assignee',	'Reporter',	'Status',	'KYC Maker',	'KYC Checker',	'Account Activity Report Owner',	'Compliance Owner',	'TM Owner',	'Account ID',	'Trigger Reason',	'Trigger Type',	'Single Pass',	'Complex Case',	'KYC Case Tag',	'Trigger Set Off Time',	'Created',	'Updated',	'Priority',	'Be raised from which team']]
    
    issues.forEach(issue => {
        var row = [
            issue.fields.customfield_12706, //legal entity id
            issue.fields.issuetype.name, //issue type
            issue.key, //key
            issue.fields.summary, //summary
            issue.fields.assignee ? issue.fields.assignee.displayName : 'NaN', //assignee
            issue.fields.reporter.displayName, //reporter
            issue.fields.status.name, //status
            issue.fields.customfield_12714 ? issue.fields.customfield_12714[0].displayName : 'NaN', //maker
            issue.fields.customfield_12715 ? issue.fields.customfield_12715[0].displayName : 'NaN', //checker
            issue.fields.customfield_12723 ? issue.fields.customfield_12723[0].displayName : 'NaN', //aar owner
            issue.fields.customfield_12716 ? issue.fields.customfield_12716[0].displayName : 'NaN', //compliance
            issue.fields.customfield_12717 ? issue.fields.customfield_12717[0].displayName : 'NaN', //tm
            issue.fields.customfield_12707, //account id
            issue.fields.customfield_12720 ? (issue.fields.customfield_12720.child?issue.fields.customfield_12720.value+' - '+issue.fields.customfield_12720.child.value:issue.fields.customfield_12720.value+' - NaN') : 'NaN - NaN', //trigger reason
            issue.fields.customfield_12711 ? issue.fields.customfield_12711.value : (issue.fields.issuetype.name=='Periodic Review'?'Periodic Review':'NaN'), //trigger type
            issue.fields.customfield_12709 ? issue.fields.customfield_12709.value : 'NaN', //single pass or not
            issue.fields.customfield_12718 ? issue.fields.customfield_12718.value : 'NaN', // complex case or not
            issue.fields.customfield_12712 ? issue.fields.customfield_12712.value : 'NaN',// team tag gc/intl
            issue.fields.customfield_12704, // set off time
            issue.fields.created, //created
            issue.fields.updated, //updated
            issue.fields.priority.name, //priority
            issue.fields.customfield_12710 ? issue.fields.customfield_12710.value : 'NaN', //raised by which team
        ]
        result.push(row)
    })
    sheet.getRange(1, 1, result.length, result[0].length).setValues(result)
}
```

#### get tickets transition records  
```gs
// tickets that were last updated within 90 days
function jql_search() {
  var jiraUrl = 'https://airwallex.atlassian.net/rest/api/3/search'
  var username = 'ben.chen@airwallex.com'
  var apiToken = 'xxxx'
  
  var jqlQuery = "PROJECT IN (CEOPS) AND issuetype in ('CN Inbound File Upload','Multiple GA') AND updated >= -90d ORDER BY created ASC"
  var maxResults = 100 // Max results per request
  var startAt = 0      // Pagination start index
  var results = []
  var tickets = []
  var total = Infinity
  var options = {
    'method': 'get',
    'headers': {
        'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + apiToken)
    }
  }
  while (startAt < total) {
    var response = UrlFetchApp.fetch(jiraUrl + '?jql=' + encodeURIComponent(jqlQuery) + '&maxResults=' + maxResults + '&startAt=' + startAt, options)
    var data = JSON.parse(response.getContentText())

    results = results.concat(data.issues)
    total = data.total // Total number of issues to fetch
    startAt += maxResults // Move to the next batch
  }
  results.forEach(
    r => {
      tickets.push([r.key, r.fields.issuetype.name])
    }
  )

  return tickets
}


// status transition logs for single ticket
function transition_records(key=['CEOPS-24671', 'CN Inbound File Upload']) {
  var jiraUrl = 'https://airwallex.atlassian.net/rest/api/3/issue/'+key[0]+'?expand=changelog'
  var username = 'ben.chen@airwallex.com'
  var apiToken = 'xxx'
  var options = {
      'method': 'get',
      'headers': {
          'Authorization': 'Basic ' + Utilities.base64Encode(username + ':' + apiToken)
      }
  }
  var response = UrlFetchApp.fetch(jiraUrl, options)
  var now = new Date()
  var data = JSON.parse(response.getContentText());
  var results = []

  // Ensure the changelog and histories exist
  if (data.changelog && data.changelog.histories) {
    var records = data.changelog.histories;

    records.forEach(record => {
      // Iterate over the items in each history record
      if (Array.isArray(record.items)) {
        record.items.forEach(item => {
          var created = new Date(record.created)
          if (item.field == 'status' && record.author.emailAddress && ['KYC Maker in review', 'WAITING FOR APPROVAL - KYC'].includes(item.fromString) && Math.ceil((now-created) / (1000 * 60 * 60 * 24)) <= 90) {
            var row = [
              key[0],
              key[1],
              Utilities.formatDate(created, Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss'),
              record.author.emailAddress,
              item.fromString,
              item.toString
            ]
            results.push(row)
          }
        });
      }
    });
  } else {
    Logger.log('No changelog or history data available.');
  }

  return results
}


// status transition logs for thoese tickets which were last updated within 90 days
function mainRun() {
  var key_list = jql_search()
  var df = [['Key No.', 'Issue Type', 'Operate Time', 'Operator Mail', 'Status From', 'Status To']]
  var sh_log = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Review Logs [rolling 90d]')
  key_list.forEach(
    key => {
      Logger.log(key)
      var logs = transition_records(key=key)
      Logger.log(logs)
      df = df.concat(logs)
    }
  )
  sh_log.clear()
  sh_log.getRange(1, 1, df.length, df[0].length).setValues(df)
}
```

---

### how to write instroduction wallpaper in menu selection  
#### html  
```html
<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <p><b>Part A: Periodic Review</b></p>
  </head>
  <body>
    <p>Tabs of [`Refresh of Old Jira` | `Refresh of New Jira` | `Workpaper-A`] are all generated from <a href = 'https://colab.research.google.com/drive/19JINNHOVQ3OlamlUdEWTEu88BDdAPaOH#scrollTo=1K0WT7bSQbSJ'>Python Tool</a> firstly, you can follow the handbook in Tool to know how to read them.</p>
    <p>Tab of [`Helper Tab`] is used for reference when running tool, it includes head mapping logic and block list from <a href = 'https://docs.google.com/spreadsheets/d/1aAlmuZneIJmcfQMxgkKxNOwWj0uLWSudT3jjFbJzOZs/edit?gid=0#gid=0'>LongPending Gsheet</a></p>
    <p>Tab of [`Workpaper-B`] is used for managing mail settings, like subjects, to_list, cc_list;
      <br>>> mail subject is totally auto generated by mail tool itself;
      <br>>> columns E, F, G, H are all mail addresses, F is auto list of all account owners, the others are all free-edit lists;
      <br>>> before sending mail, remember to update the column A and B here, by copying lists from right side;
      <br>>> you must at least input 1 to_mail and 1 cc_mail here, or it would raise bug error while running;
    </p>
    <p>Click the 'T60/30_Report' in SmartFunctions to send the mail
      <br>>> it is sugguested that the first mail can be sent to your own private inbox, to check the output;
      <br>>> if the amount of cc and to receivers is more than 100, script would go wrong, and a letter would be generated in kyc ops inbox to notify you about this;
    </p>
    <p>Click the 'T60 Block List Update' in SmartFunctions to add the T60 clients in the backend of <a href = 'https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0'>block list</a></p>
    <p>Click the 'T30 Alert List Replace' in SmartFunctions to fully replace the T30 clients on <a href = 'https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0'>pending list</a></p>
  </body> 
  <div style="height: 50px;"></div>
  <head>
    <base target="_top">
    <p><b>Part B: Material Trigger</b></p>
  </head>
  <body>
    <p>Old Jira would not be involved here, because the client there have all been added into watchlist and not need for refreshing any more.</p>
    <p>Tabs of [`Refresh of New Jira` | `Workpaper-A`] are both generated from <a href = 'https://colab.research.google.com/drive/19rR3ddHGBXi3nOGFvlT9mgbLqjWFYz3z#scrollTo=Jswe4RQl7McH'>Python Tool</a> firstly, you can follow the handbook in Tool to know how to read them.</p>
    <p>Tab of [`Helper Tab`] is used for reference when running tool, it includes head mapping logic and watchlist list from <a href = 'https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=877572013#gid=877572013'>LongPending Gsheet</a></p>
    <p>Tab of [`Workpaper-B`] is used for managing mail settings, like to_list, cc_list;
      <br>>> mail subject is totally auto generated by mail tool itself;
      <br>>> columns E, F, G, H are all mail addresses, F is auto list of all account owners, the others are all free-edit lists;
      <br>>> before sending mail, remember to update the column A and B here, by copying lists from right side;
      <br>>> you must at least input 1 to_mail and 1 cc_mail here, or it would raise bug error while running;
    </p>
    <p>Click the 'T30/20_Report' in SmartFunctions to send the mail
      <br>>> it is sugguested that the first mail can be sent to your own private inbox, to check the output;
      <br>>> if the amount of cc and to receivers is more than 100, script would go wrong, and a letter would be generated in kyc ops inbox to notify you about this;
    </p>
    <p>Click the 'T30 Block List Update' in SmartFunctions to add the T30 clients in the backend of <a href = 'https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0'>block list</a></p>
  </body>
</html>
```
#### call  
```gs
function instruction() {
  var htmlOutput = HtmlService.createHtmlOutputFromFile('how_to_use.html')
  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'How to use this Gsheet to send weekly report')
}
```

---

### how to send a mail, using the template written by html
#### html
```html
<!DOCTYPE html>
<html>
  <head>
    <style>
        .spaced {
            margin-bottom: 60px; /* Adjust as needed for spacing */
        }
    </style>
  </head>
  <body>
    <p>Hi Commercial Team</p>
    <p>Kindly find the weekly tracking report of the KYC periodical review (PR) long-pending client list as below, and the REQUIRED ACTION is also highlighted for your attention and follow-up.</p>
    <p><b>Here is the full list for your reference: </b><a href = 'https://lookerstudio.google.com/u/0/reporting/f41789bb-a2af-4897-aa15-7982d33437e5/page/i376D'>KYC Periodical Review (PR) & Material Trigger (MT) Long Pending Client List</a></p>

    <!-- Part of T60 clients -->
    <p class='spaced'></p>
    <p style='color:red;'><b>Part 1: Below newly identified client's KYC PR is overdue more than 60 days without a response, all future transactions from the client will be blocked until PR is completed.</b></p>
    <? if (t60_len == 0) { ?> 
      <p><b>No customer should be newly added into watchlist.</b></p>
    <? } else { ?>
      <p><b>REQUIRED ACTION: </b></p>
      <p><b>1) Please help to contact the respective client ASAP and complete the PR review, or</b></p>
      <p><b>2) Inform the KYC team to offboard the client if no future relationship is required</b></p>
      <table border='1' cellspacing='0'>
        <thead>
          <tr bgcolor='lightblue'>
          <? for (var i = 0; i < head_t60.length; i++) { ?>
              <th style='white-space:nowrap'><?= head_t60[i] ?></th>
          <? } ?>
          </tr>
        </thead>
        <tbody>
          <? for (var i = 0; i < data_t60.length; i++) { ?>
            <tr>
              <td><?= data_t60[i].summary ?></td>
              <td><?= data_t60[i].legalEntityId ?></td>
              <td><?= data_t60[i].customerSegment ?></td>
              <td><?= data_t60[i].accountOwner ?></td>
              <td><?= data_t60[i].head ?></td>
              <td><?= data_t60[i].lastRfiTime ?></td>
            </tr>
          <? } ?>
        </tbody>
      </table>
      <p>KYC will add into watchlist accordingly.</p>
      <p>Hi 
        <? for (var i = 0; i < cn_head_t60.length; i++) { ?>
          <a href = 'mailto: https://www.airwallex.com/'><?= cn_head_t60[i] ?></a>, 
        <? } ?>
        KYC will place the control on customers until the review is completed, and the KYC review RFI has been sent; Please help to inform the right teammate if the owner changes.
      </p>
      <p>Hi 
        <? for (var i = 0; i < intl_head_t60.length; i++) { ?>
          <a href = 'mailto: https://www.airwallex.com/'><?= intl_head_t60[i] ?></a>, 
        <? } ?>
        KYC will place the control on customers until the review is completed, you should have been cc-ed in these KYC review RFI emails, and if need further assistance please approach to <a href = 'mailto: joann.qiu@airwallex.com'>Joann Qiu</a>
      </p>
    <? } ?>

    <!-- Part of T30 clients -->
    <p class='spaced'></p>
    <p style='color:red;'><b>Part 2: Below client's KYC PR is overdue for more than 30 days without a response, if no response before the Due date (T+60), the client's future transactions will be blocked.</b></p>
    <? if (t30_len == 0) { ?> 
      <p><b>No customer in T+30.</b></p>
    <? } else { ?>
      <p><b>REQUIRED ACTION: </b></p>
      <p><b>1) Please help to contact the respective client ASAP and complete the PR review, or</b></p>
      <p><b>2) Inform the KYC team to offboard the client if no future relationship is required</b></p>
      <table border='1' cellspacing='0'>
        <thead>
          <tr bgcolor='lightblue'>
          <? for (var i = 0; i < head_t30.length; i++) { ?>
              <th style='white-space:nowrap'><?= head_t30[i] ?></th>
          <? } ?>
          </tr>
        </thead>
        <tbody>
          <? for (var i = 0; i < data_t30.length; i++) { ?>
            <tr>
              <td><?= data_t30[i].summary ?></td>
              <td><?= data_t30[i].legalEntityId ?></td>
              <td><?= data_t30[i].customerSegment ?></td>
              <td><?= data_t30[i].accountOwner ?></td>
              <td><?= data_t30[i].head ?></td>
              <td><?= data_t30[i].lastRfiTime ?></td>
              <td><?= data_t30[i].dueDate ?></td>
            </tr>
          <? } ?>
        </tbody>
      </table>
      <p>Hi 
        <? for (var i = 0; i < cn_head_t30.length; i++) { ?>
          <a href = 'mailto: https://www.airwallex.com/'><?= cn_head_t30[i] ?></a>, 
        <? } ?>
        KYC review RFI has been sent; Please help to inform the right teammate if the owner changes.
      </p>
      <p>Hi 
        <? for (var i = 0; i < intl_head_t30.length; i++) { ?>
          <a href = 'mailto: https://www.airwallex.com/'><?= intl_head_t30[i] ?></a>, 
        <? } ?>
        you should have been cc-ed in these KYC review RFI emails, and if need further assistance please approach to <a href = 'mailto: joann.qiu@airwallex.com'>Joann Qiu</a>
      </p>
    <? } ?>
    <p>Best regards,<br>KYC Operation Team</p>
  </body>
</html>
```
#### mail part
```gs
function dataGroupPR() {

  const work_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Workpaper-A')
  var pending_q60 = []
  var pending_q45 = []
  var pending_q30 = []
  const rawdata = work_sheet.getRange('A2:Q'+getLastRow(work_sheet,'A:A')).getDisplayValues()

  for (var i=0; i<rawdata.length; i++) {
    if (rawdata[i][9]==' [T+60]') {
      pending_q60.push({
        summary: rawdata[i][2],
        legalEntityId: rawdata[i][1],
        customerSegment: rawdata[i][11],
        orgL2: rawdata[i][12],
        accountOwner: rawdata[i][13],
        head: rawdata[i][16],
        lastRfiTime: rawdata[i][4].substring(0, 19)
      })
    }
    else if (rawdata[i][9]==' [T+30]' || rawdata[i][9]==' [T+45]') {
      pending_q30.push({
        summary: rawdata[i][2],
        legalEntityId: rawdata[i][1],
        customerSegment: rawdata[i][11],
        orgL2: rawdata[i][12],
        accountOwner: rawdata[i][13],
        head: rawdata[i][16],
        lastRfiTime: rawdata[i][4].substring(0, 19),
        dueDate: rawdata[i][7].substring(0, 10),
      })
    }

  }
  
  return [pending_q30, pending_q45, pending_q60]
}


function send_3060() {
  let datagroup = dataGroupPR()
  var htmlTemplate = HtmlService.createTemplateFromFile('mail_content_t3060.html')

  // part of T60
  var head_t60 = ['Client Name', 'Legal Entity Id', 'Customer Segment', 'Account Owner', 'Commercial Head', 'Last RFI Time']
  var data_t60 = datagroup[2]
  var cn_head_t60 = []
  var intl_head_t60 = []
  data_t60.forEach(
    r => {
      r.orgL2.substring(0, 2) == 'CN' ? cn_head_t60.push(r.head) : {}
      r.orgL2.substring(0, 2) != 'CN' ? intl_head_t60.push(r.head) : {}
    }
  )
  cn_head_t60 = [... new Set(cn_head_t60)]
  intl_head_t60 = [... new Set(intl_head_t60)]
  htmlTemplate.data_t60 = data_t60  // Pass the t60 data array to the template
  htmlTemplate.head_t60 = head_t60
  htmlTemplate.t60_len = data_t60.length
  htmlTemplate.cn_head_t60 = cn_head_t60
  htmlTemplate.intl_head_t60 = intl_head_t60
  // htmlTemplate.t60_len = 0

  // part of T30
  var head_t30 = ['Client Name', 'Legal Entity Id', 'Customer Segment', 'Account Owner', 'Commercial Head', 'Last RFI Time', 'Due Date']
  var data_t30 = datagroup[0]
  var cn_head_t30 = []
  var intl_head_t30 = []
  data_t30.forEach(
    r => {
      r.orgL2.substring(0, 2) == 'CN' ? cn_head_t30.push(r.head) : {}
      r.orgL2.substring(0, 2) != 'CN' ? intl_head_t30.push(r.head) : {}
    }
  )
  cn_head_t30 = [... new Set(cn_head_t30)]
  intl_head_t30 = [... new Set(intl_head_t30)]
  htmlTemplate.data_t30 = data_t30  // Pass the t60 data array to the template
  htmlTemplate.head_t30 = head_t30
  htmlTemplate.t30_len = data_t30.length
  htmlTemplate.cn_head_t30 = cn_head_t30
  htmlTemplate.intl_head_t30 = intl_head_t30

  // pass the processed html template into gmail app
  var htmlBody = htmlTemplate.evaluate().getContent()

  // get the title, to, cc
  let mailsetting = getMailSet()
  var mail_subject = 'Weekly Report - KYC Periodical Review (PR) Long Pending Client List' + mailsetting[0]
  var mail_to = mailsetting[1]
  var mail_cc = mailsetting[2]

  if (mail_to.length+mail_cc.length > 100) {
    GmailApp.sendEmail(
      'kyc.ops@airwallex.com',
      'Error Response - ' + mail_subject,
      '收件人超过上限；调整一下，先单独发给自己的邮箱，再手动复制黏贴群发。'
    )
  } else {
    GmailApp.sendEmail(
      mail_to.join(','),
      mail_subject,
      '',
      {htmlBody: htmlBody, cc: mail_cc.join(','), replyTo: 'joann.qiu@airwallex.com'}
      )
    Browser.msgBox('🍻Mail is delivered successfully!')
    }
}
```

---

### update the range content (replace and append)  
```gs
function transferPR_T30() {

  const work_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Workpaper-A')
  const to_sheet = SpreadsheetApp.openByUrl('https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0').getSheetByName('Periodical Review (PR)')
  const rawdata = work_sheet.getRange('A2:O'+getLastRow(work_sheet,'A:A')).getDisplayValues()
  let pending_queue = []

  for (var i=0; i<rawdata.length; i++) {
    if (rawdata[i][9]==' [T+30]' || rawdata[i][9]==' [T+45]') {
      pending_queue.push([
        rawdata[i][2], //summary
        rawdata[i][1], //legalEntityId
        'PR Reminder: over 30 days no RFI responce',
        rawdata[i][13], //accountOwner
        rawdata[i][11], //customerSegment
        rawdata[i][12], //org_L2
        'Added on ' + Utilities.formatDate(new Date(),"GMT+8","yyyy-MM-dd")
      ])
    }
  }

  var current_list = to_sheet.getRange('A2:G'+getLastRow(to_sheet,'B:B')).getDisplayValues()
  current_list = current_list.filter(r => r[2] != 'PR Reminder: over 30 days no RFI responce')
  current_list = current_list.concat(pending_queue)

  to_sheet.getRange('A2:H').clear()
  to_sheet.getRange(2, 1, current_list.length, current_list[0].length).setValues(current_list)

  Browser.msgBox('🍻Reminder list is updated successfully!')
}


function transferPR_T60() {

  const work_sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Workpaper-A')
  const to_sheet = SpreadsheetApp.openByUrl('https://docs.google.com/spreadsheets/d/1N26v0ILmaIndXsCxtDh4bUizypbzVm2smUjsMXbuz2I/edit?gid=0#gid=0').getSheetByName('Periodical Review (PR)')
  const rawdata = work_sheet.getRange('A2:O'+getLastRow(work_sheet,'A:A')).getDisplayValues()
  let pending_queue = []

  for (var i=0; i<rawdata.length; i++) {
    if (rawdata[i][9] == ' [T+60]') {
      pending_queue.push([
        rawdata[i][2], //summary
        rawdata[i][1], //legalEntityId
        'PR Block tanx: Over 60 days no RFI responce',
        rawdata[i][13], //accountOwner
        rawdata[i][11], //customerSegment
        rawdata[i][12], //org_L2
        'Added on ' + Utilities.formatDate(new Date(),"GMT+8","yyyy-MM-dd")
      ])
    }
  }

  to_sheet.getRange(getLastRow(to_sheet,'A:A')+1, 1, pending_queue.length, pending_queue[0].length).setValues(pending_queue)
  to_sheet.getRange(2, 1, to_sheet.getLastRow()-1, to_sheet.getLastColumn()).sort({column: 3, ascending: true})

  Browser.msgBox('🍻Block list is updated successfully!')
}
```

---

### interact with slack  
#### send msg to channel  
```gs
function slackapp_last_msg(month, ticket, amount, days, sla, comment, slackurl, gsheeturl) {
  
  var param = {

    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(
      {
				"type": "mrkdwn",
				"text": '📢📢 *Issuing Recon Breaks Overdue Reminder*' + '\n' + '\n'
              + '• *Month:* ' + month + '\n'
              + '• *Jira Ticket:* ' + '<https://airwallex.atlassian.net/browse/' + ticket + '|' + ticket + '>' + '\n'
              + '• *Pending Amount ($):* ' + amount + '\n'
              + '• *SLA Target:* ' + sla + '\n' 
              + '• *Pending Days:* ' + days + ' days' + '\n' 
              + '• *Comments from Issuing:* ' + comment + '\n' + '\n'
              // + '<@U01AS2QKZL2> ' + '<@U014TU31HH9>' + '\n' + '\n' // 只希望出现在最后一条msg通知里，其他的msg不要出现@person了
              + '<' + gsheeturl + ' | Link to the full list and details>' // 只希望出现在最后一条msg通知里，其他的msg不要出现link了
      }
    )
  }

  UrlFetchApp.fetch(slackurl, param)
  Logger.log(param)

}

function slackapp(month, ticket, amount, days, sla, comment, slackurl) {
  
  var param = {

    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(
      {
				"type": "mrkdwn",
				"text": '📢📢 *Issuing Recon Breaks Overdue Reminder*' + '\n' + '\n'
              + '• *Month:* ' + month + '\n'
              + '• *Jira Ticket:* ' + '<https://airwallex.atlassian.net/browse/' + ticket + '|' + ticket + '>' + '\n'
              + '• *Pending Amount ($):* ' + amount + '\n'
              + '• *SLA Target:* ' + sla + '\n' 
              + '• *Pending Days:* ' + days + ' days' + '\n' 
              + '• *Comments from Issuing:* ' + comment + '\n'
      }
    )
  }

  UrlFetchApp.fetch(slackurl, param)
  Logger.log(param)

}



function slackapp_Run() {

  const sheet_from = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Record')
  const content = sheet_from.getRange(2, 1, getLastRow(sheet_from, 'A:A')-1, 7).getDisplayValues()
  // const slackurl = 'https://hooks.slack.com/services/testxxx/B050KK3HSD6/bP2NuOnYSxKJXgwKFGixswpf' // Test Use Only
  const slackurl = 'https://hooks.slack.com/services/testxxx/B06U8N1BTMG/1DhZ8CeYKR4g6PfT2gqK92ZN' // linked with channel of # issuing-recon
  // const slackurl = 'https://hooks.slack.com/services/testxxx/B06U0PLLTDZ/LDO8PHJ9Dh0lwHiHBeLhSmFv' // linked with channel of # issuing-recon-breaks-alert-test
  const gsheeturl = 'https://docs.google.com/spreadsheets/d/1xOb36DN_uAyZ2ebKfxjcqAGKSCCtNxAyOjXw5yeNgzQ/edit#gid=312672034'
  const overdue_amt = sheet_from.getRange('F:F').getDisplayValues().flat().filter(x => x=='Overdue').length

  var i = 1

  content.forEach(

    r => {

      let month = r[0]
      let ticket = r[1]
      let amount = r[2]
      let days = r[3]
      let sla = r[4]
      let status = r[5]
      let comment = r[6]

      Logger.log(r)

      if (status == 'Overdue' && i == overdue_amt) {
        slackapp_last_msg(month, ticket, amount, days, sla, comment, slackurl, gsheeturl)
        
      }
      else if (status == 'Overdue' && i != overdue_amt) {
        slackapp(month, ticket, amount, days, sla, comment, slackurl)
        i += 1
      }
      else {
        Logger.log('%s %s %s %s %s %s', month, ticket, amount, days, sla, status, comment)
      } 

      Utilities.sleep(500) //freeze 0.5s

    }

  )

}
```

#### dynamically mention people  
```gs
// mock user mapping based on owning-entity and txn-type
var userMapping = {
  'AU': {
    'FEE': ["U059ZSBCAD9"],
    'ADJUSTMENT': ["U059ZSBCAD9", "UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["U059ZSBCAD9"],
    'CONVERSION': ["U059ZSBCAD9"],
    'CARD_TX': ["U059ZSBCAD9", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U059ZSBCAD9", "U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'PAYMENT': ["U059ZSBCAD9", "U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DC_DEBIT': ["U059ZSBCAD9", "UA437DMEK"],
    'DD_DEBIT': ["U059ZSBCAD9", "UA437DMEK"],
    'PURCHASE': ["U059ZSBCAD9", "U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  },
  'CN': {
    'FEE': ["UEHLJM5FF", "UA437DMEK"],
    'ADJUSTMENT': ["UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["UA437DMEK"],
    'CONVERSION': ["UEHLJM5FF", "UA437DMEK"],
    'CARD_TX': ["UEHLJM5FF", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'PAYMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DC_DEBIT': ["UEHLJM5FF", "UA437DMEK"],
    'DD_DEBIT': ["UEHLJM5FF", "UA437DMEK"],
    'PURCHASE': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  },
  'HK': {
    'FEE': ["U0490S6TV0Q", "UA437DMEK"],
    'ADJUSTMENT': ["UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["UA437DMEK"],
    'CONVERSION': ["U0490S6TV0Q", "UA437DMEK"],
    'CARD_TX': ["U0490S6TV0Q", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'PAYMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DC_DEBIT': ["U0490S6TV0Q", "UA437DMEK"],
    'DD_DEBIT': ["U0490S6TV0Q", "UA437DMEK"],
    'PURCHASE': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  },
  'SG': {
    'FEE': ["UA437DMEK"],
    'ADJUSTMENT': ["UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["UA437DMEK"],
    'CONVERSION': ["U0490S6TV0Q", "UA437DMEK"],
    'CARD_TX': ["U0490S6TV0Q", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'PAYMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DC_DEBIT': ["U0490S6TV0Q", "UA437DMEK"],
    'DD_DEBIT': ["U0490S6TV0Q", "UA437DMEK"],
    'PURCHASE': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  },
  'UK': {
    'FEE': ["U01ECV5S8CB"],
    'ADJUSTMENT': ["UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["U01ECV5S8CB"],
    'CONVERSION': ["U01ECV5S8CB", "UA437DMEK"],
    'CARD_TX': ["U01ECV5S8CB", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK", "U05JT3FV466", "U01ECV5S8CB"],
    'PAYMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK", "U05JT3FV466", "U01ECV5S8CB"],
    'DC_DEBIT': ["U01ECV5S8CB", "UA437DMEK"],
    'DD_DEBIT': ["U01ECV5S8CB", "UA437DMEK"],
    'PURCHASE': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK", "U05JT3FV466", "U01ECV5S8CB"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  },
  'US': {
    'FEE': ["U02Q0AE4UP2"],
    'ADJUSTMENT': ["UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["U02Q0AE4UP2"],
    'CONVERSION': ["U02Q0AE4UP2", "UA437DMEK"],
    'CARD_TX': ["U02Q0AE4UP2", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK", "U06BWE5PWBG"],
    'PAYMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK", "U06BWE5PWBG"],
    'DC_DEBIT': ["U02Q0AE4UP2", "UA437DMEK"],
    'DD_DEBIT': ["U02Q0AE4UP2", "UA437DMEK"],
    'PURCHASE': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK", "U06BWE5PWBG"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  },
  'Others': {
    'FEE': ["UC01YJ823"],
    'ADJUSTMENT': ["UA437DMEK", "UC01YJ823"],
    'WITHDRAW': ["UC01YJ823"],
    'CONVERSION': ["UC01YJ823", "UA437DMEK"],
    'CARD_TX': ["UC01YJ823", "U04KCPVNREJ", "U05ESDDULBT"],
    'ACQUIRING_BATCH_SETTLEMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'PAYMENT': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DC_DEBIT': ["UC01YJ823", "UA437DMEK"],
    'DD_DEBIT': ["UC01YJ823", "UA437DMEK"],
    'PURCHASE': ["U0231QGK2NN", "U06KJ6R26DS", "U079TRQTKA4", "U080ESNQRCK"],
    'DEPOSIT_REVERSAL': ["UA437DMEK", "UC01YJ823"],
    'PAYOUT': ["UA437DMEK", "UC01YJ823"]
  }
};

function slackapp_template_10k(account_id, legal_entity_id, client_name, owning_entity, org_l2, account_owner, last_nb_date, net_account_balance_usd, txn_mapping_id, nb_txn_type, nb_txn_sub_typ, nb_txn_domain, nb_txn_reason, url) {
  var country_code = String(org_l2).substring(0, 2)
  var knownRegions = ['AU', 'CN', 'HK', 'SG', 'UK', 'US']
  var region = knownRegions.includes(country_code) ? country_code : 'Others'
  // defaults to xxx if no mapping is found
  var userIds = ["UC01YJ823", "UR0STDE9F"]
  // fetch user ids
  if (userMapping[region] && userMapping[region][nb_txn_type]) {
    userIds = userMapping[region][nb_txn_type];
  }
  // construct dynamic user mention elements, with delimiters
  var userMentionElements = [];
  userIds.forEach((userId, index) => {
    userMentionElements.push({
      "type": "user",
      "user_id": userId
    });
    // add a space after every user mention, except the last one
    if (index < userIds.length - 1) {
      userMentionElements.push({
        "type": "text",
        "text": " "
      });
    }
  });
  // block kit
  var param = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({
      'text': 'This is the fallback text for clients that do not support blocks',
      'blocks': [
        {
        "type": "rich_text",
        "elements": [
          {
            "type": "rich_text_preformatted",
            "border": 0,
            "elements": [
              {
                "type": "text",
                "text": `Legal Entity Id: ${legal_entity_id}\nAccount Id: ${account_id}\nClient Name: ${client_name}\nOwning Entity: ${owning_entity}\nBD Team: ${org_l2}\nAccount Owner: ${account_owner}\nNet Account Balance ($): ${net_account_balance_usd}\nLatest Balance Negative Date: ${last_nb_date}\nBalance Negative Txn Type: ${nb_txn_type}\nBalance Negative Txn Sub_type: ${nb_txn_sub_typ}\nBalance Negative Txn Reason: ${nb_txn_reason}\nBalance Negative Txn Domain: ${nb_txn_domain}\nBalance Negative Txn Id: ${txn_mapping_id}`
              }
            ]
          },
          {
            "type": "rich_text_section",
            "elements": [
              {
                "type": "text",
                "text": "\n"
              },
              {
                "type": "link",
                "url": "https://lookerstudio.google.com/u/0/reporting/d323ec88-3699-4e1e-a01c-c4cac622c0c2/page/cZMdE",
                "text": "Go to dashboard"
              },
              {
                "type": "text",
                "text": "\n\nHi "
              },
              ...userMentionElements,  // spread the user mentions into the elements array
              {
                "type": "text",
                "text": ", the Net Account Balance of this client has fallen below $-10K, please take the necessary follow-up actions. "
              },
              {
                "type": "emoji",
                "name": "point_up_2",
                "unicode": "1f446"
              },
              {
                "type": "emoji",
                "name": "point_up_2",
                "unicode": "1f446"
              },
              {
                "type": "emoji",
                "name": "point_up_2",
                "unicode": "1f446"
              }
            ]
				  }
        ]
        }
      ]
    })
  }

  UrlFetchApp.fetch(url, param)
  Utilities.sleep(1000)
}
```

#### bullet list and make the blank spaces dynamic structured
```gs
...
  var element_list = []
  for (i in content) {
    element_list.push(
      `{
        "type": "rich_text_section",
        "elements": [
          {
            "type": "text",
            "text": "${content[i][16]} hrs",
            "style": {
              "code": true
            }
          },
          {
            "type": "text",
            "text": "${' '.repeat(Math.max(...[8 - 2*`${content[i][16]}`.toString().length, 2]))}"        
          },
          {
            "type": "text",
            "text": " CLE Id: ${content[i][1]} "
          }
        ]
      }`
    )
  }
...
    {
      "type": "rich_text_list",
      "style": "bullet",
      "indent": 0,
      "border": 0,
      "elements": convertStringToJsonArray(element_list)
    },
...
```

---

### how to check the bigquery refresh status  
```gs
  // check the refresh status
  sh_accountbase.getRange('A1').activate()
  var bq_params = sh_accountbase.getCurrentCell().getDataSourceTables()[0].getStatus()

  var bq_status = bq_params.getExecutionState()
  if (bq_status != 'SUCCESS') {
    slackapp_error_alert(
      slackurl=url, 
      bq_status=bq_status, 
      error_msg=bq_params.getErrorMessage(), 
      last_refresh_time=bq_params.getLastExecutionTime(), 
      last_success_time=bq_params.getLastRefreshedTime()
    )
    return 0
  }
```

---

### how to work with filter
```gs
const filter = region_sheet.getFilter()
// if there is an existing filter in the tab, it should be released, or it would jump out error
if (filter != null) {
filter.remove()
}

// filter criteria
let criteria_1 = SpreadsheetApp.newFilterCriteria().whenTextEqualTo('TRUE').build()
let filter_1 = region_sheet.getRange('A1:R').createFilter()
filter_1.setColumnFilterCriteria(18, criteria_1)

// paste the filter result into an temporary tab
let helper_tab = SpreadsheetApp.getActiveSpreadsheet().insertSheet('Temporary')
region_sheet.getRange('A1:R').copyTo(helper_tab.getActiveRange(), SpreadsheetApp.CopyPasteType.PASTE_VALUES, false)

let raw_content = helper_tab.getRange('A1:R'+getLastRow(helper_tab,'A:A')).getDisplayValues()
	      .map(
		function(row) {
		      var intValue = parseInt(row[16]);
		      if (!isNaN(intValue)) { // Check if the parsed value is not a NaN before assigning
			row[16] = intValue;
		      }
		      return row;
		}
	      )
	      .sort(function(a, b) {
		return b[16] - a[16];
	      })

raw_content.shift()  // return and remove the first element from the array
...
region_sheet.getFilter().remove()
```

---

### quality sampling  
#### get random samples  
```gs
function getRandomTopElements(list, numElements) {
  // 1. Create an array of objects with each item and a random number
  var itemsWithRandom = list.map(function (item) {
    return {
      originalItem: item,
      randomValue: Math.random()
    };
  });

  // 2. Sort this array based on the random number
  itemsWithRandom.sort(function (a, b) {
    return a.randomValue - b.randomValue;
  });

  // 3. Extract the first `numElements` items from the sorted array
  // and map to get only the original items (not the random numbers)
  var selectedItems = itemsWithRandom.slice(0, numElements).map(function (element) {
    return element.originalItem;
  });

  // 4. Return these selected items
  return selectedItems;
}
```

---

### others  
```gs
function getHolidays(ccy) {
  var ss = SpreadsheetApp.openById('1kjZJU7nnY4xI5uy_tNifYcpbR-IDnPQTdktEFdh7IQs').getSheetByName('Static holiday data')
  var rangelist = ss.getRangeList(['B1:B', 'F1:F4'])
  var allValues = rangelist.getRanges().map(function (range) {
    return range.getValues().flat(); // Retrieves the values for each individual range
  })

  var holiday_list = []
  allValues[0].forEach(
    (r, n) => {
      r == ccy ? holiday_list.push(String(allValues[1][n])) : {}
    }
  )

  for (i in holiday_list) {

    let year = holiday_list[i].substring(0, 4)
    let month = holiday_list[i].substring(4, 6)
    let day = holiday_list[i].substring(6)
    holiday_list[i] = Utilities.formatDate(new Date(year, month - 1, day), 'GMT+8', 'yyyy-MM-dd')

  }

  // Logger.log(holiday_list.includes(Utilities.formatDate(new Date('6/12/2024 0:05:55'),'GMT+8', 'yyyy-MM-dd')))
  return holiday_list
}
```
```gs
function formatNumberWithTwoDecimals(number) {
  var number = Number(number)

  var options = {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  };
  var formattedNumber = number.toLocaleString('en-US', options);

  return formattedNumber
  // Logger.log(formattedNumber); // Output will be '1,234,567.89'
}
```
```gs
SpreadsheetApp.flush()
Utilities.sleep(50)
```
```gs
var addrowdatas = []
var addrowdata = [monthbatch, qaid, entity, casetype, match_result, nsid, l1owner, l2owner, l3owner, alert]
addrowdatas.push(addrowdata)
to_sheet.getRange(getLastRow(to_sheet, 'A:A') + 1, 1, addrowdatas.length, 10).setValues(addrowdatas)
```
```gs
function convertStringToJsonArray(your_string_dictionary) {
  var jsonString = '[' + your_string_dictionary + ']'; // Concatenate your string dictionaries into a valid JSON array string
  jsonString = jsonString.replace(/\n/g, ""); // Remove newline characters if they are part of the string
  
  // Parse the valid JSON string to a JavaScript array of objects
  var jsonArray;
  try {
    jsonArray = JSON.parse(jsonString);
  } catch (e) {
    Logger.log('Error parsing JSON: ' + e);
    return; // Exit the function if parsing fails
  }
  
  // Do something with the jsonArray
  // Logger.log(jsonArray);
  
  return jsonArray;
}
```
